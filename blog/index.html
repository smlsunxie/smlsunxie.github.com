
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]>
  <html class="no-js lte-ie8">
<![endif]-->

<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]>
<html class="no-js" lang="en">
<!--<![endif]-->

<head>
  <meta charset="utf-8">

  <title>Blog - 蹤影</title>
  <meta name="author" content="smlsun">
  <meta name="Generator" content="Jekyll & Octopress (http://octopress.org)">

  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="Content-Language" content="zh-TW" />
  <meta http-equiv="Content-Language" content="zh-Hant-TW" />
  <meta name="URL" content="http://smlsun.com">



  
  
  
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://smlsun.com/blog/">



 


  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">

  <link href="/assets/magnus/css/style.css"  rel="stylesheet" type="text/css">

  <script src="/javascripts/octopress.min.js" type="text/javascript"></script>


  <script src="/assets/magnus/js/bootstrap.js"></script>

  <script defer="defer" src="/assets/magnus/js/custom.js"></script>




  <link href="/atom.xml" rel="alternate" title="蹤影" type="application/atom+xml">
  
<!--Fonts from Google's Web font directory at http://google.com/webfonts -->
<link href='http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic' rel='stylesheet' type='text/css'>

<!-- Deck.js -->
<!-- Style theme. Located in /themes/style/ or create your own. -->
<link rel="stylesheet" href="/assets/css/deck.js/themes/style/.css" type='text/css'>
<!-- Transition theme. Located in /themes/transition/ or create your own. -->
<link rel="stylesheet" href="/assets/css/deck.js/themes/transition/.css" type='text/css'>

<!-- Add fancyBox -->
<link rel="stylesheet" href="/assets/css/jquery.fancybox.css?v=2.0.4" type="text/css" media="screen" />
<script type="text/javascript" src="/javascripts/jquery.fancybox.js?v=2.0.4"></script>

<!-- Add fancyBox jQuery -->
<script type="text/javascript">
  $(document).ready(function() {
      $(".fancybox").fancybox();
  });
</script>
<!-- End fancyBox insert -->

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-36297314-2']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


   
  <link href="/favicon.png" rel="icon">
</head>

<body   class="no-sidebar"  >
  

  <header role="banner">
  	<div class="container">
			<div class="row">
				<hgroup class="logo span3">
					

<i class="ico-thin-right-arrow ico-color circle"></i>
<a class="brand" href="/">
	
	<span>蹤影</span>.

</a>
<!-- 		
	<h2>學習新事物，分享交流的地方，歡迎～</h2>
 -->








				</hgroup>

				<nav class="span9">
			  	
<div class="navbar navbar-inverse">
  <div class="navbar-inner">
    <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
    </a>

    <div class="nav-collapse collapse">


      <ul class="nav">
        	<li  >
		<a href="/">Home</a>
	</li>
  
  <li class="active" >
  	<a href="/blog">Blog</a>
  </li>

  <li >
  	<a href="/archives">Archives</a>
  </li>
  
  <li >
    <a href="/aboutme">AboutMe</a>
  </li>

  <li >
  	<a href="/slides">Slides</a>
  </li>

  
      </ul>
      <ul class="nav" data-subscription="rss">





        <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
        
        
        <li>
          <div class="search-content">
            <form action="http://google.com/search" method="get">
              <fieldset role="search">
                <input type="hidden" name="q" value="site:smlsun.com" />
                <input class="search-query" id="search-query" type="text" name="q" results="0" placeholder="Search"/>
              </fieldset>
            </form>
          </div>


        </li>

      </ul>





    </div>
  </div>
</div>










				</nav>

			</div>
  	</div>
  </header>


	<div id="page-title">

		<div id="page-title-inner">

			<!-- start: Container -->
			<div class="container">


				<h2><i class="ico-pencil"></i>
				
					
						Blog
					
				

				</h2>

			</div>
			<!-- end: Container  -->
		</div>	
	</div>









	<div id="wrapper">	
		<!--start: Container -->
    	<div id="content" class="container">

    		<div class="row">

    
    <div class="span12"> 
    
    
      










    <div class="post " >
      
<div class="post-content">


  <hr>
  
  <div class="post-title">
    
<h1 class="entry-title">

<a href="/blog/2014/01/20/Moto-Ranger/">服務上線發表-Moto Ranger 線上摩托維修記錄</a>

</h1>

  </div>
  

  <hr>


  <div class="post-description">
    <p>服務上線發表，不知道別人在產品上線的情形是如何，我個人是非常緊張&#8230;</p>

<p>因為家裡開的是機車維修店，常常遇到客戶明明很久以前就換過機油，或是輪胎煞車皮之類的日常保養，卻還是說我前不久才換過，苦無證據，因此開發了一個可以記錄客戶維修歷史記錄的服務，順便也幫傳統的機車行加入一些資訊管理。</p>

<p>傳統摩托維修店家，沒有一個簡易的維修記錄軟體，很難記錄到底熟客有哪些，一個月的營業額有多少，所使用的零件成本也是憑感覺，往往沒辦法確實估算一個車行營運的成本與利潤，並且沒有辦法好好管理客戶資料，有時候確實會發生車子修理好，但是聯絡客戶的資訊找不到的窘境，維修車行是個需要專業並且辛苦的工作，工時又長，來客就是賺錢的機會，憑著維修記錄，也可以提醒客戶該做定期的維修保養，提供完善的服務。</p>

<p>並且在車行的營業環境中會有很多粉塵，在開發此系統時，也考慮提供手機或是平板瀏覽器（android 或是 iOS）的相容，即使沒有 PC 也可以進行。</p>

<p>在打造維修記錄的服務時，一開始的開發對象是店家的維修記錄的管理，但在過程中，發現個人也有需求，相信有在開車或是騎車的朋友一定也會有忘記自己的愛車是什麼時候加過機油（在下也是），觀察一下網路上的服務，甚至是手機 app  似乎沒有一個比較合適簡單的維修記錄軟裡，也有看到很多朋友使用 blog 來記錄維修記錄(辛苦！)，每個人的生命中多少有幾個 [第二老婆] 陪你浪跡天涯，好好愛護才能走更遠的路，萬一因為忘記什麼時候加過機油造成引擎損壞，那就得不償失了。</p>

<p>此外，一旦您的愛車要出售時，也可以附上維修記錄，證明皆有正常維修，讓你的愛車更有價格上的競爭力。</p>

<p>於是基於店家的管理，以及個人的需求，筆者開發一個線上服務，恭敬的為大家介紹；</p>

<h2><a href="http://motoranger.net/">Moto Ranger - 線上摩托維修記錄</a></h2>

<p><img src="https://lh6.googleusercontent.com/--p7y5sSzaIw/UtzT00Q2siI/AAAAAAAAMEs/n3MRFddM8jE/s0/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7+2014-01-20+%E4%B8%8B%E5%8D%883.43.42.png" title="螢幕快照 2014-01-20 下午3.43.42.png" alt="enter image description here" /></p>

<h2>店家首頁</h2>

<p><img src="https://lh5.googleusercontent.com/-Z0OB8dowktA/Utzjhr4-Q3I/AAAAAAAAMFU/_LNNBRVDtYU/s0/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7+2014-01-20+%E4%B8%8B%E5%8D%883.52.24.png" title="螢幕快照 2014-01-20 下午3.52.24.png" alt="enter image description here" /></p>

<h2>維修記錄</h2>

<p><img src="https://lh4.googleusercontent.com/-7x73juU0x9Q/Ut0Cq2N_ezI/AAAAAAAAMF8/w2ZkLskZJe8/s0/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7+2014-01-20+%E4%B8%8B%E5%8D%887.03.22.png" title="螢幕快照 2014-01-20 下午7.03.22.png" alt="enter image description here" /></p>

<p>取名為 Moto Ranger 是要向我「<a href="http://blog.smlsun.com/2013/12/this-guy-is-my-bro.html">那流浪漢黑手 bro</a>」，「<a href="http://blog.tin613.com/">tin613</a>」 致敬，勇於追逐自己的夢想，雖然這只是一個小服務，但這是我的第一步，2013 年的總結，雖不知道這服務會發展到什麼程度，但至少在路上了，歡迎大家來使用。</p>

<p>再將近一年陸陸續續的開發中，由家裡的師父當我的早期試用者，陸陸續續也改善了一些流程的問題，在 2013 年末 密集的開發下，總算可以推出供個人與車行使用的線上維護記錄軟體，為了因應個資法，也加入相關的資料防護，方便大家使用的通用維修項目，以及使用導覽，若一開始不知道如何操作的朋友，註冊完成後，登入系統會先進行導覽，幫助您快速上手。</p>

<p>若是個人使用，可以直接線上註冊，若是車行有興趣，可以與我聯繫，期初我會在挑選幾家進行早期測試。</p>

<p>因為剛開始公開測試，若再使用中有任何問題或意見歡迎來信建議，或是直接在服務中的「意見回饋」進行留言，您的意見會讓這個服務更好！</p>

<p>或者，您也可以在我們的 <a href="https://www.facebook.com/pages/%E5%8B%9D%E7%A5%A5%E6%A9%9F%E8%BB%8A%E8%A1%8C-Moto-Ranger/252043181598683">facebook 專頁 Moto Ranger</a> 留下您的意見。</p>

  </div>


  

  <hr>
  <div class="post-meta">
    
    <span>








  




<i class="mini-ico-calendar"></i><time datetime="2014-01-20T00:00:00+08:00" pubdate data-updated="true">Jan 20<span>th</span>, 2014</time></span>

    <span><i class="mini-ico-bookmark"></i><a rel="bookmark" href="/blog/2014/01/20/Moto-Ranger/"></a></span>
    

    
    <span><i class="mini-ico-comment"></i><a class="comments-link" href="/blog/2014/01/20/Moto-Ranger/#disqus_thread">View comments &raquo;</a></span>
    

    

  </div>

  



</div>
    </div>
    
      










    <div class="post " >
      
<div class="post-content">


  <hr>
  
  <div class="post-title">
    
<h1 class="entry-title">

<a href="/blog/2014/01/19/ubuntu/">Ubuntu 忘記密碼怎麼辦？三個步驟完成修改</a>

</h1>

  </div>
  

  <hr>


  <div class="post-description">
    <ol>
<li><p>游標移到 recovery mode (不要 enter)，鍵盤輸入 e，表示編輯 command</p>

<p> <img src="https://lh3.googleusercontent.com/-IIwTTUyywEk/UsYdxqpauxI/AAAAAAAAL_k/drrfABMruQI/s0/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7+2014-01-03+%E4%B8%8A%E5%8D%8810.16.36.png" title="螢幕快照 2014-01-03 上午10.16.36.png" alt="enter image description here" /></p></li>
<li><p>修改關鍵字 <code>ro recovery nomodeset</code>：</p>

<p> <img src="https://lh5.googleusercontent.com/-WMKHLt4bS5s/UsYgsBGuviI/AAAAAAAAL_4/q8PIplU5CLU/s0/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7+2014-01-03+%E4%B8%8A%E5%8D%8810.29.47.png" title="螢幕快照 2014-01-03 上午10.29.47.png" alt="enter image description here" /></p>

<p> ro 表示 readonly，標準只有提供幾個內建功能，若要修改密碼我們需要用到 bash 的 passwd 的指令，將其改為 <code>rw single init=/bin/bash</code>，表示進入 single user mode，也就是 root 使用者，並且載入 bash 令我們可以修改密碼：</p>

<p> <img src="https://lh5.googleusercontent.com/-V7A7bn00g50/UsYhmVEx6gI/AAAAAAAAMAE/v8B8EEJwl1k/s0/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7+2014-01-03+%E4%B8%8A%E5%8D%8810.33.42.png" title="螢幕快照 2014-01-03 上午10.33.42.png" alt="enter image description here" /></p></li>
<li><p>修改完成後，鍵盤輸入 ctrl-x 進入 recovary：</p>

<p> 可以看到游標停在 <code>root@(none):/#:</code>，現在我們有了 root 權限，如此一來在有最大權限的情況下，你就可以任意調整 server</p></li>
<li><p>輸入 <code>passwd username</code> 就可以進行修改密碼。</p></li>
</ol>


<h3>完工</h3>

  </div>


  

  <hr>
  <div class="post-meta">
    
    <span>








  




<i class="mini-ico-calendar"></i><time datetime="2014-01-19T00:00:00+08:00" pubdate data-updated="true">Jan 19<span>th</span>, 2014</time></span>

    <span><i class="mini-ico-bookmark"></i><a rel="bookmark" href="/blog/2014/01/19/ubuntu/"></a></span>
    

    
    <span><i class="mini-ico-comment"></i><a class="comments-link" href="/blog/2014/01/19/ubuntu/#disqus_thread">View comments &raquo;</a></span>
    

    

  </div>

  



</div>
    </div>
    
      










    <div class="post " >
      
<div class="post-content">


  <hr>
  
  <div class="post-title">
    
<h1 class="entry-title">

<a href="/blog/2014/01/19/rabbit-MQ-Spring-boot/">Rabbit Mq Spring Boot</a>

</h1>

  </div>
  

  <hr>


  <div class="post-description">
    <hr />

<p>title: &#8220;rabbit MQ 與 Spring boot 整合，以 RPC mode 為例&#8221;
layout: post</p>

<h2>categories: rabbit MQ, java, spring, spring boot</h2>

<p>最近在開發的專案剛好有使用到 rabbit MQ，也花了一點時間了解運作原理，關於使用 MQ 的好處，與各種應用情形，網路上有很多，有需要可以搜尋看看，本篇要說明的是 rabbit MQ 與 java 的串接，在實作的過程中花了一些時間，希望透過這篇的說明可以幫助到有需要的人。</p>

<p>在開始說明前，先簡單說明一下 RPC 模式的運作：</p>

<p>在 rabbit MQ 的官網<a href="http://www.rabbitmq.com/tutorials/tutorial-six-python.html">關於 RPC 的介紹</a>，模型示意圖如下：</p>

<p><img src="http://www.rabbitmq.com/img/tutorials/python-six.png" alt="enter image description here" /></p>

<p>可以看到在 RPC 模式下分為 client 與 server，request 與 Reply 分別有各自的隊列負責，本範例使用 spring AmqpTemplate 作為 client 進行操作，在上圖中總共有四個重要的成員，分為 client 與 server 跟大家介紹。</p>

<p>一開始要先跟大家說明的是，在整個 java 與 rabbit MQ 整合有個很重要的物件為 <code>ConnectionFactory connectionFactory</code>，該物件存放了存取 rabbit MQ server 的相關資訊，包括登入帳號與密碼，因此在此範例中不管 client、server 或是去跟回的隊列都會跟他有關係，因此一開始我們需要先建立 ConnectionFactory。</p>

<p>因為是用 spring boot 開發，預設只要有使用到  amqp 套件，spring 在啟動時就算你沒有特別設定，就會產生好有預設參數的 bean 等待你取用，本範例沒有用到特殊參數，因此透過下列程式就可以取得 ConnectionFactory 實體：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>@Autowired
</span><span class='line'>ConnectionFactory connectionFactory;</span></code></pre></td></tr></table></div></figure>


<p>所謂的預設值分別是 ip、port、帳號、密碼等，client 與 server 用的會是一個物件，接著我們就可以來看 client 的定義。</p>

<h2>client</h2>

<p>client 是訊息的發起方，一開始我們需要先定義 client 的隊列，RPC 模式有去有回，對於 client 而言，他需要消化的隊列是 reply，因此我們需要先將 client 與 reply 進行綁定，首先需要先定義 reply 隊列：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>final static String queueName = "reply";
</span><span class='line'>
</span><span class='line'>@Bean
</span><span class='line'>public Queue responseQueue() {
</span><span class='line'>    return new Queue(queueName);
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>一旦隊列建立完成，再來要設定 amqpTemplete，還記得剛剛說的 connectionFactory 儲存了存取  MQ server 的相關資訊，因此在建立時需要傳入，建立以後綁定 reply 隊列，如下：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>@Bean
</span><span class='line'>public RabbitTemplate amqpTemplate() {
</span><span class='line'>    RabbitTemplate rabbitTemplate = new RabbitTemplate(connectionFactory);
</span><span class='line'>    rabbitTemplate.setReplyQueue(responseQueue());
</span><span class='line'>    return rabbitTemplate;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>接著我們需要設定 SimpleMessageListenerContainer，首先為了讓 SimpleMessageListenerContainer 可以存取隊列訊息，所以他也需要 ConnectionFactory，一旦 amqpTemplate 送出訊息後，將透過 SimpleMessageListenerContainer 去監看 replay 的隊列有沒有新的訊息近來並且要將訊息傳給 amqpTemplate，因此 SimpleMessageListenerContainer 需要綁定 amqpTemplate 與 replay 隊列，設定的程式碼如下：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>@Bean
</span><span class='line'>public SimpleMessageListenerContainer clientMessageListenerContainer() {
</span><span class='line'>    SimpleMessageListenerContainer container = new SimpleMessageListenerContainer();
</span><span class='line'>    container.setConnectionFactory(connectionFactory);
</span><span class='line'>    container.setQueues(responseQueue());
</span><span class='line'>    container.setMessageListener(amqpTemplate());
</span><span class='line'>    return container;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>如此就完成 client 的設定，完整程式碼如下：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>package goinfo.test;
</span><span class='line'>
</span><span class='line'>import org.springframework.amqp.core.Queue;
</span><span class='line'>import org.springframework.amqp.rabbit.connection.ConnectionFactory;
</span><span class='line'>import org.springframework.amqp.rabbit.core.RabbitTemplate;
</span><span class='line'>import org.springframework.amqp.rabbit.listener.SimpleMessageListenerContainer;
</span><span class='line'>import org.springframework.beans.factory.annotation.Autowired;
</span><span class='line'>import org.springframework.context.annotation.Bean;
</span><span class='line'>import org.springframework.context.annotation.Configuration;
</span><span class='line'>
</span><span class='line'>@Configuration
</span><span class='line'>public class MqClientConfig {
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>    @Autowired
</span><span class='line'>    ConnectionFactory connectionFactory;
</span><span class='line'>
</span><span class='line'>    final static String queueName = "reply";
</span><span class='line'>
</span><span class='line'>    @Bean
</span><span class='line'>    public Queue responseQueue() {
</span><span class='line'>        return new Queue(queueName);
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    @Bean
</span><span class='line'>    public RabbitTemplate amqpTemplate() {
</span><span class='line'>        RabbitTemplate rabbitTemplate = new RabbitTemplate(connectionFactory);
</span><span class='line'>        rabbitTemplate.setReplyQueue(responseQueue());
</span><span class='line'>        return rabbitTemplate;
</span><span class='line'>    }
</span><span class='line'>    @Bean
</span><span class='line'>    public SimpleMessageListenerContainer clientMessageListenerContainer() {
</span><span class='line'>        SimpleMessageListenerContainer container = new SimpleMessageListenerContainer();
</span><span class='line'>        container.setConnectionFactory(connectionFactory);
</span><span class='line'>        container.setQueues(responseQueue());
</span><span class='line'>        container.setMessageListener(amqpTemplate());
</span><span class='line'>
</span><span class='line'>        return container;
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h1>server</h1>

<p>server 的部分同樣需要 ConnectionFactory connectionFactory，跟  client 一樣，這邊不多說明，除了 connectionFactory，第一步要定義的是 server 所要消化的對列，也就是上圖中的 rpc_queue，我們將隊列命名為 spring-boot 如下：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>@Autowired
</span><span class='line'>ConnectionFactory connectionFactory;
</span><span class='line'>
</span><span class='line'>final static String queueName = "spring-boot";
</span><span class='line'>
</span><span class='line'>@Bean
</span><span class='line'>Queue queue() {
</span><span class='line'>    return new Queue(queueName, false);
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>我們需要一個類別來處理由 rpc_queue 傳入的訊息，並且定義一旦接收到 message 之後，要呼叫哪個函式，透過 MessageListenerAdapter 來幫我們完成：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>@Bean
</span><span class='line'>AmqpController receiver() {
</span><span class='line'>    return new AmqpController();
</span><span class='line'>}
</span><span class='line'>@Bean
</span><span class='line'>MessageListenerAdapter listenerAdapter(AmqpController receiver) {
</span><span class='line'>    return new MessageListenerAdapter(receiver, "receiveMessage");
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>AmqpController 是我們要處理 message 的類別，而 <code>MessageListenerAdapter(receiver, "receiveMessage");</code>這一句表示，一旦接收到訊息，要呼叫 receiver 物件中所定義的 <code>receiveMessage</code> 方法， AmqpController 程式碼如下：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>
</span><span class='line'>import goinfo.service.ApiFecadeService;
</span><span class='line'>import org.springframework.beans.factory.annotation.Autowired;
</span><span class='line'>
</span><span class='line'>public class AmqpController {
</span><span class='line'>
</span><span class='line'>    @Autowired
</span><span class='line'>    private ApiFecadeService apiFecadeService;
</span><span class='line'>
</span><span class='line'>  public String receiveMessage(String message) {
</span><span class='line'>        return apiFecadeService.excute(apiFecadeService, message);
</span><span class='line'>    }
</span><span class='line'>}
</span></code></pre></td></tr></table></div></figure>


<p>可以看到我們定義了 receiveMessage method，所傳入的 message 將透過 MessageListenerAdapter 傳入，return 的部份就是要傳入 reply 隊列的內容。</p>

<p>這邊不得不補充一下，自己在研究時，一直想不透到底要怎麼將處理的結果回傳給 reply，因為 spring AMQP 官方的範例是最單純的有去沒回的模式，因此在宣告 receiveMessage 是  void 而不是 String，嘗試許多方法，靈機想說該不會直接 return 就會傳給 reply，果不其然&#8230;就是這麼簡單！</p>

<p>一旦 MessageListenerAdapter 設定好，我們同樣需要設定 SimpleMessageListenerContainer，該物件的建立同樣需要 ConnectionFactory 作為存取隊列的依據，與 client 類似，但不一樣的是隊列對象是 rpc_queue，而訊息的處理交由 MessageListenerAdapter 傳入 AmqpController，設定如下：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>@Bean
</span><span class='line'>SimpleMessageListenerContainer serverMessageListenerContainer(MessageListenerAdapter listenerAdapter) {
</span><span class='line'>    SimpleMessageListenerContainer container = new SimpleMessageListenerContainer();
</span><span class='line'>    container.setConnectionFactory(connectionFactory);
</span><span class='line'>    container.setQueues(queue());
</span><span class='line'>    container.setMessageListener(listenerAdapter);
</span><span class='line'>    return container;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>完整的程式如下：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>package goinfo.cfg;
</span><span class='line'>
</span><span class='line'>import goinfo.web.AmqpController;
</span><span class='line'>import org.springframework.amqp.core.Queue;
</span><span class='line'>import org.springframework.amqp.rabbit.connection.ConnectionFactory;
</span><span class='line'>import org.springframework.amqp.rabbit.listener.SimpleMessageListenerContainer;
</span><span class='line'>import org.springframework.amqp.rabbit.listener.adapter.MessageListenerAdapter;
</span><span class='line'>import org.springframework.beans.factory.annotation.Autowired;
</span><span class='line'>import org.springframework.context.annotation.Bean;
</span><span class='line'>import org.springframework.context.annotation.Configuration;
</span><span class='line'>
</span><span class='line'>@Configuration
</span><span class='line'>public class MqServerConfig {
</span><span class='line'>
</span><span class='line'>    @Autowired
</span><span class='line'>    ConnectionFactory connectionFactory;
</span><span class='line'>
</span><span class='line'>    final static String queueName = "spring-boot";
</span><span class='line'>
</span><span class='line'>    @Bean
</span><span class='line'>    Queue queue() {
</span><span class='line'>        return new Queue(queueName, false);
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    @Bean
</span><span class='line'>    AmqpController receiver() {
</span><span class='line'>        return new AmqpController();
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    @Bean
</span><span class='line'>    MessageListenerAdapter listenerAdapter(AmqpController receiver) {
</span><span class='line'>        return new MessageListenerAdapter(receiver, "receiveMessage");
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    @Bean
</span><span class='line'>    SimpleMessageListenerContainer serverMessageListenerContainer(MessageListenerAdapter listenerAdapter) {
</span><span class='line'>        SimpleMessageListenerContainer container = new SimpleMessageListenerContainer();
</span><span class='line'>        container.setConnectionFactory(connectionFactory);
</span><span class='line'>        container.setQueues(queue());
</span><span class='line'>        container.setMessageListener(listenerAdapter);
</span><span class='line'>        return container;
</span><span class='line'>    }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>如此就完成 client 與 server 端的設定，可以開始實際使用。</p>

<p>另外在 MQ 的運行中還有一個很重要的參與者名為 exchange，若有需要也可以透過下面的程式碼綁定：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>@Bean
</span><span class='line'>TopicExchange exchange() {
</span><span class='line'>    return new TopicExchange("spring-boot-exchange");
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>@Bean
</span><span class='line'>Binding binding(Queue queue, TopicExchange exchange) {
</span><span class='line'>    return BindingBuilder.bind(queue).to(exchange).with(queueName);
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>沒有設定也沒有關係，spring boot 會幫你設定好預設為 server 的 queue 名稱加上 -exchange，此例來說就是 spring-boot-exchange。</p>

<h2>範例訊息送出與接收</h2>

<p>在這裡我們建立一個 TestController 進行訊息的組成在透過一開始在 client 說明中建立的 AmqpTemplete 將訊息送出，如下：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>import org.springframework.amqp.rabbit.core.RabbitTemplate;
</span><span class='line'>import org.springframework.beans.factory.annotation.Autowired;
</span><span class='line'>
</span><span class='line'>@Controller
</span><span class='line'>public class TestController {
</span><span class='line'>
</span><span class='line'>    @Autowired
</span><span class='line'>    RabbitTemplate amqpTemplate;
</span><span class='line'>    public String sendMsg() {
</span><span class='line'>        Object o = amqpTemplate.convertSendAndReceive("spring-boot", "{test: 'OK'}");
</span><span class='line'>        return result;
</span><span class='line'>    }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>最後再整理一下整個執行的過程：</p>

<ol>
<li>使用 amqpTemplate 所提供的 convertSendAndReceive，表示送出訊息後要等待接收 reply</li>
<li>透過該函式將訊息送到指定的隊列名稱為 <code>spring-boot</code>，透過 connectionFactory 將訊息傳給 rpc_quene</li>
<li>Server 端的  serverMessageListenerContainer，一發現 rpc_quene 有新的訊息，就會把訊息傳給 listenerAdapter，交由 AmqpController 處理</li>
<li>一旦 AmqpController 的 receiveMessage 函式處理完成後，將處理結果 return</li>
<li>此時 serverMessageListenerContainer 根據從 amqpTemplate 送出訊息裡包含的 <a href="http://stackoverflow.com/questions/18403623/rabbitmq-amqp-basicproperties-builder-values">BasicProperties</a> 知道要回傳到隊列 reply</li>
<li>一旦隊列 reply 有了新訊息，client 的 clientMessageListenerContainer 監控到 reply 新的訊息需要處理，根據 clientMessageListenerContainer 綁定的 MessageListener 對象為一開始發出訊息的 amqpTemplate，將處理結果傳入，回到原點，完成整個交易過程。</li>
</ol>


<p>最後附上在 MQ server 控制頁的模型圖示：</p>

<p><img src="https://lh6.googleusercontent.com/-rhWN2FC7ceo/Us9gs33fNeI/AAAAAAAAMBQ/oU231Uq9gP8/s0/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7+2014-01-10+%E4%B8%8A%E5%8D%8810.52.55.png" title="螢幕快照 2014-01-10 上午10.52.55.png" alt="enter image description here" /></p>

<p>若是以 rabbit MQ server 角度來看，當你送出訊息時，訊息會送到與 spring-boot 隊列成對的 exchange，spring-boot-exchange 綁定了 spring-boot 與 reply 隊列。</p>

<p>上圖中的藍色線就是當你送出 message 時會出現代表有新訊息傳入，在交由 exchange 去分派到對應的隊列。</p>

<p>寫了很多，希望可以幫助到需要的朋友。</p>

  </div>


  

  <hr>
  <div class="post-meta">
    
    <span>








  




<i class="mini-ico-calendar"></i><time datetime="2014-01-19T00:00:00+08:00" pubdate data-updated="true">Jan 19<span>th</span>, 2014</time></span>

    <span><i class="mini-ico-bookmark"></i><a rel="bookmark" href="/blog/2014/01/19/rabbit-MQ-Spring-boot/"></a></span>
    

    
    <span><i class="mini-ico-comment"></i><a class="comments-link" href="/blog/2014/01/19/rabbit-MQ-Spring-boot/#disqus_thread">View comments &raquo;</a></span>
    

    

  </div>

  



</div>
    </div>
    
      










    <div class="post " >
      
<div class="post-content">


  <hr>
  
  <div class="post-title">
    
<h1 class="entry-title">

<a href="/blog/2014/01/19/rabbit-MQ/">Rabbit MQ 使用者建立與權限設定</a>

</h1>

  </div>
  

  <hr>


  <div class="post-description">
    <p>安裝 rabbit MQ 非常簡單，<a href="https://www.rabbitmq.com/download.html">官方就有介紹</a>，安裝完成後，可以透過指令 <code>rabbitmq-server</code> 來啟動 MQ server。</p>

<p>一旦安裝完成，可透過下面網址進入控管 MQ server 的主控台：</p>

<p><code>http://localhost:15672/</code></p>

<p>在瀏覽器輸入上述網址後，預設帳號密碼為 <code>guest/guest</code>，登入後會看到畫面如下：</p>

<p><img src="https://lh5.googleusercontent.com/-QLG8IN_RDtI/Ur0lQZP-imI/AAAAAAAAL70/2N3Rb4O1pCQ/s0/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7+2013-12-27+%E4%B8%8B%E5%8D%882.58.50.png" title="螢幕快照 2013-12-27 下午2.58.50.png" alt="enter image description here" /></p>

<p>主要頁面呈現了關於 MQ server 目前的狀態，包括隊列的情形，環境參數等，有需要可以點選看看，本篇要說明的是如何建立或改變使用者帳號。</p>

<h4>建立或改變使用者帳號</h4>

<ol>
<li><p>點選上圖中導覽列的 Admin 會進入下面的畫面</p>

<p> <img src="https://lh3.googleusercontent.com/-cvd7yKB403c/Ur0lrKf1LyI/AAAAAAAAL8A/ZUd-FF8KvXY/s0/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7+2013-12-27+%E4%B8%8B%E5%8D%883.00.39.png" title="螢幕快照 2013-12-27 下午3.00.39.png" alt="enter image description here" /></p></li>
<li><p>點選 add a user 就可以輸入要新增的帳號</p>

<p> <img src="https://lh4.googleusercontent.com/-jOyv6P2vvO8/Ur0mGS9N5VI/AAAAAAAAL8M/H73RkFTDZ8c/s0/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7+2013-12-27+%E4%B8%8B%E5%8D%883.02.24.png" title="螢幕快照 2013-12-27 下午3.02.24.png" alt="enter image description here" /></p></li>
<li><p>輸入完成後，可以看到如下圖：</p>

<p> <img src="https://lh4.googleusercontent.com/-fCYZHvcrbI0/Ur0mVLaKgdI/AAAAAAAAL8c/DSXoXMqtKZQ/s0/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7+2013-12-27+%E4%B8%8B%E5%8D%883.03.26.png" title="螢幕快照 2013-12-27 下午3.03.26.png" alt="enter image description here" /></p>

<p> 表示使用者新增完成。</p></li>
<li><p>接著設定存取權限，所以接著點選上圖表格中 Name 欄位的 admin，進入下面畫面：</p>

<p> <img src="https://lh5.googleusercontent.com/-yeuQj-nJAHY/Ur0m4_r0bJI/AAAAAAAAL8s/EJEkATgSeeY/s0/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7+2013-12-27+%E4%B8%8B%E5%8D%883.05.38.png" title="螢幕快照 2013-12-27 下午3.05.38.png" alt="enter image description here" /></p>

<p> 預設為全部允許，如此一來就可以透過設定好的帳號密碼來進行控管。</p></li>
</ol>


  </div>


  

  <hr>
  <div class="post-meta">
    
    <span>








  




<i class="mini-ico-calendar"></i><time datetime="2014-01-19T00:00:00+08:00" pubdate data-updated="true">Jan 19<span>th</span>, 2014</time></span>

    <span><i class="mini-ico-bookmark"></i><a rel="bookmark" href="/blog/2014/01/19/rabbit-MQ/"></a></span>
    

    
    <span><i class="mini-ico-comment"></i><a class="comments-link" href="/blog/2014/01/19/rabbit-MQ/#disqus_thread">View comments &raquo;</a></span>
    

    

  </div>

  



</div>
    </div>
    
      










    <div class="post " >
      
<div class="post-content">


  <hr>
  
  <div class="post-title">
    
<h1 class="entry-title">

<a href="/blog/2014/01/19/Window/">Window 設定：開機自動執行程式或 *.bat 不需登入，以啟動 Spring-boot 應用程式為例，加映 Command Line 就能搞定的 Geek 版</a>

</h1>

  </div>
  

  <hr>


  <div class="post-description">
    <p>使用 spring-boot 的好處之一，不需要額外安裝 tomcat，也不需要包成 war 檔進行 deploy，我們可以直接包成 jar 檔之後透過比如下面的指令進行啟動服務：<code>java -jar service-1.0.0.jar</code>，可以這麼做的原因是 spring-boot 使用 tomcat-embed 作為 service，所以可以直接使用 jar 運行，作為 server 啟動。</p>

<p>完整的啟動 bat 內容如下：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>set JAVA_HOME=E:\service\Java\jdk1.7.0_45
</span><span class='line'>set JAVA_JRE=E:\service\Java\jre7
</span><span class='line'>java -jar service-1.0.0.jar</span></code></pre></td></tr></table></div></figure>


<p>設定好 JAVA_HOME 以及 JAVA_JRE 即可不受 window 自動更新 JDK 造成相容性問題，最後再執行 <code>java -jar service-1.0.0.jar</code> 即可啟動服務。</p>

<p>當程式開發好之後，實際發佈到主機作為 production 運行時，我們不希望偶爾的 window 自動更新重啟時造成服務未開啟，讓客戶錯以為系統有問題，在 window 底下最簡單的自動啟動指定的應用程式是將捷徑放置於開始功能列中的 [<code>啟動</code>] 資料夾，這樣的作法有幾個問題：</p>

<ol>
<li>需要登入才會觸動，所以若是自動更新重啟沒有登入也是沒效</li>
<li>若有遠端登入也會啟動，造成重覆開啟</li>
</ol>


<p>我們可以用另外一種設定方式來進行透過 [工作排程器]，步驟如下：</p>

<ol>
<li><p>啟動工作排程器
 <img src="https://lh6.googleusercontent.com/-sY2DBkcNQmg/UteGzqS4V0I/AAAAAAAAMCc/a3jB0bIxGhE/s0/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7+2014-01-16+%E4%B8%8B%E5%8D%882.52.44.png" title="螢幕快照 2014-01-16 下午2.52.44.png" alt="enter image description here" /></p></li>
<li><p>建立基本工作
 <img src="https://lh6.googleusercontent.com/-GvMx7nrfvHk/UteG_RMFp8I/AAAAAAAAMCo/k4R8KaF-EJ8/s0/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7+2014-01-16+%E4%B8%8B%E5%8D%882.53.13.png" title="螢幕快照 2014-01-16 下午2.53.13.png" alt="enter image description here" /></p></li>
<li><p>定義服務名稱
 <img src="https://lh5.googleusercontent.com/-sijmvNua4Ik/UteHI0q2lsI/AAAAAAAAMC0/jhZ7yxP6UH8/s0/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7+2014-01-16+%E4%B8%8B%E5%8D%882.53.46.png" title="螢幕快照 2014-01-16 下午2.53.46.png" alt="enter image description here" /></p></li>
<li><p>定義啟動時機
 <img src="https://lh3.googleusercontent.com/-8NGvtH4yfog/UteI1fvaaxI/AAAAAAAAMDo/sW64MwnYkZw/s0/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7+2014-01-16+%E4%B8%8B%E5%8D%883.20.49.png" title="螢幕快照 2014-01-16 下午3.20.49.png" alt="enter image description here" /></p></li>
<li><p>選擇工作類型，選擇啟動程式
 <img src="https://lh4.googleusercontent.com/-z0JtzmxDECc/UteHSqKqU9I/AAAAAAAAMDA/SySPxMM9bfg/s0/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7+2014-01-16+%E4%B8%8B%E5%8D%882.54.16.png" title="螢幕快照 2014-01-16 下午2.54.16.png" alt="enter image description here" /></p></li>
<li><p>選擇要執行的 bat 檔
 <img src="https://lh3.googleusercontent.com/-PUmGanA4O7w/UteI9opVxdI/AAAAAAAAMD0/SEWz5gr0p5k/s0/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7+2014-01-16+%E4%B8%8B%E5%8D%883.21.23.png" title="螢幕快照 2014-01-16 下午3.21.23.png" alt="enter image description here" /></p></li>
</ol>


<p>如此一來，系統就會在啟動時執行目標工作啦，記得要寫 log，因為這樣的運行模式下沒有 console 視窗，有任何異常都要從 log 檔查看。</p>

<p>同場加映：</p>

<p>宏大 <a href="http://blog.lyhdev.com/">lyhcode</a> 詢問：</p>

<blockquote><p>有沒有用 command line 就能搞定的 geek 版？</p></blockquote>

<p>感謝 <a href="http://www.dotblogs.com.tw/jamesfu/">jamesFu</a> 大師解答：</p>

<blockquote><p>schtask /create /sc onstart /tn Service /tr &#8220;E:\service\run.bat&#8221; /ru</p></blockquote>

  </div>


  

  <hr>
  <div class="post-meta">
    
    <span>








  




<i class="mini-ico-calendar"></i><time datetime="2014-01-19T00:00:00+08:00" pubdate data-updated="true">Jan 19<span>th</span>, 2014</time></span>

    <span><i class="mini-ico-bookmark"></i><a rel="bookmark" href="/blog/2014/01/19/Window/"></a></span>
    

    
    <span><i class="mini-ico-comment"></i><a class="comments-link" href="/blog/2014/01/19/Window/#disqus_thread">View comments &raquo;</a></span>
    

    

  </div>

  



</div>
    </div>
    
      










    <div class="post " >
      
<div class="post-content">


  <hr>
  
  <div class="post-title">
    
<h1 class="entry-title">

<a href="/blog/2014/01/19/Spring-Security-oauth2/">Spring Security: Oauth2 運作原理解析筆記</a>

</h1>

  </div>
  

  <hr>


  <div class="post-description">
    <p>繼上一篇 <a href="http://blog.smlsun.com/2013/12/spring-security-basic-authentication.html">Spring Security Basic Authentication with Ajax request 失敗處理</a>，說明關於如何在 Spring Security 設定 Basic Authentication 以及透過 ajax 來進行資料請求後，這篇要來說明如何使用目前各大網站常用的 oauth 驗證機制。</p>

<p>關於 oauth 的特性網路上有很多不錯的文章，推薦大家先閱讀：</p>

<h2><a href="http://www.im47.cn/post/2012/08/2012-08-04-oauth2">OAuth原理初探</a></h2>

<p>這篇有很詳細的圖文解說，最後還有關於 OAuth 和 OpenID 的區別:</p>

<blockquote><p>OAuth 關注的是授權，即：“用戶能做什麼”；而 OpenID 關注的是證明，即：“用戶是誰”。</p></blockquote>

<h2><a href="http://www.techiekernel.com/2013/02/oauth2-in-simple-way.html">OAuth2 - In a Simple Way</a></h2>

<p>這篇是英文，但在解釋 oauth 使用時機有較精準的說明:</p>

<blockquote><p>OAuth 2 provides several grant types for different use cases. The grant types defined are:</p>

<ol>
<li>Authorization Code: for apps running on a web server</li>
<li>Implicit: for browser-based or mobile apps</li>
<li>Password: for logging in with a username and password</li>
<li>Client credentials: for application access</li>
</ol>
</blockquote>

<p>可以看到 oauth 提供了各種不同狀況的應用的驗證機制，算是很完整的安全機制，另外在文中還有針對每種驗證方式提供 curl 或是 網址的驗證流程，上述兩篇文章的閱讀可以充分了解 oauth 是什麼。</p>

<h2><a href="http://cscarioni.blogspot.tw/2013/04/pro-spring-security-and-oauth-2.html">Pro Spring Security and OAUTH 2</a></h2>

<p>這邊講的就是實作啦，沒有看過上面兩篇會不知道他在幹嘛，建議可以依序在看到這一篇，該作者為 <a href="http://it-ebooks.info/book/2364/">Pro Spring Security</a> (連結可下載原文 pdf) 的作者，對於 Spring Security 的實作細節有很詳盡的說明，在書中並未包含 oauth 的說明該文章算是補足 oauth 的說明，且說明的是 oauth2 的規範，簡單來說 oauth2 簡化了 oauth，在實作上更加簡單。</p>

<p>該文章範例程式碼：<code>https://github.com/spring-projects/spring-security-oauth</code>，下載之後取出 1.0.1 版<code>git checkout 1.0.1.RELEASE</code>，在專案根目錄使用 maven，在 command 執行 <code>mvn clean install -P bootstrap</code>，將會在該專案底下的 sample 各資料夾底下 target 資料夾找到各別的 war 檔，如此就可以將 war 檔放至於 tomcat 下運行。</p>

<p>整個文章讀下來幾個比較重要的步驟說明筆記如下</p>

<h3>Tonr 之 OAuth2ClientContextFilter 過濾處理</h3>

<ol>
<li>當登入網頁需要驗證時</li>
<li>登入失敗時</li>
<li>已驗證通過會透過該 filter 到達 SparklrServiceImpl</li>
</ol>


<h3>SparklrServiceImpl 將實作存取 Sparklr 相關方法</h3>

<ol>
<li>呼叫後端 Sparklr 取得使用者特有的圖片</li>
<li>透過使用 RestOperations(OAuth2RestTemplate)取得 Sparklr 上的圖片</li>
</ol>


<h3>取得 Access Token</h3>

<ol>
<li>需要先取得 Access Token，一旦取得會存於 DefaultOAuth2ClientContext</li>
<li>一開始 DefaultOAuth2ClientContext 尚未有 Access Token 時，會從 DefaultOAuth2ClientContext 取得 AccessTokenRequest，兩者當 Spring 啟動時會自動設定，透過 bean 定義 <code>&lt;oauth:rest-template resource="sparklr" /&gt;</code> 傳給 RestTemplateBeanDefinitionParser。</li>
<li>接著在從呼叫 AccessTokenProvider 取的 Token</li>
<li>將會被 AccessTokenRequest 以及 AuthorizationCodeResourceDetails 呼叫 AccessTokenProviderChain 中的 obtainAccessToken 方法。</li>
<li>其中 AuthorizationCodeResourceDetails 定義如下，將在動時透過 ResourceBeanDefinitionParser 解析</li>
</ol>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;oauth:resource id="sparklr" type="authorization_code" client-id="tonr" client-secret="secret"
</span><span class='line'>                access-token-uri="${accessTokenUri}" user-authorization-uri="${userAuthorizationUri}" scope="read,write" /&gt;
</span><span class='line'>&lt;oauth:rest-template resource="sparklr" /&gt;</span></code></pre></td></tr></table></div></figure>


<h3>取得 Authorization Code Access Token</h3>

<ol>
<li>AccessTokenProviderChain 的 obtainAccessToken 方法將透過 設定 AccessTokenProvider 實體來取的 token，指的就是 AuthorizationCodeAccessTokenProvider</li>
<li>AuthorizationCodeAccessTokenProvider 將透過 POST 呼叫 <code>http://localhost:8080/sparklr2/oauth/authorize</code> 取得驗證碼</li>
<li>sparklr2 其中 <code>/sparklr2/oauth/authorize</code> 將定義於 FilterSecurityInterceptor</li>
<li><p>一旦 FilterSecurityInterceptor 發現沒有權限登入將會將頁面導入 <code>http://localhost:8080/sparklr2/login.jsp</code>，設定如下：</p>

<p>&#8220;`
<http access-denied-page="/login.jsp?authorization_error=true" disable-url-rewriting="true" xmlns="http://www.springframework.org/schema/security"></p>

<pre><code>&lt;intercept-url pattern="/oauth/**" access="ROLE_USER" /&gt;
&lt;intercept-url pattern="/**" access="IS_AUTHENTICATED_ANONYMOUSLY" /&gt;
&lt;form-login authentication-failure-url="/login.jsp?authentication_error=true" default-target-url="/index.jsp" login-page="/login.jsp" login-processing-url="/login.do" /&gt;
&lt;logout logout-success-url="/index.jsp" logout-url="/logout.do" /&gt;
&lt;anonymous /&gt;
</code></pre>

<p></http>
&#8220;`</p></li>
<li>redirect 到 login 頁面將會被 Tonr 的 AuthorizationCodeAccessTokenProvider 接收並且被 UserRedirectRequiredException 擷取並且丟出由 Oauth2ClientContextFilter 處理，加入額外的參數 <code>http://localhost:8080/sparklr2/login.jsp?response_type=code&amp;client_id=tonr&amp;scope=read+write&amp;state=dWby7l&amp;redirect_uri=http%3A%2F%2Flocalhost%3A8080%2Ftonr2%2Fsparklr%2Fphotos</code>，如此就可以開始進行登入</li>
</ol>


<h3>進行登入取得 USER ROLE</h3>

<ol>
<li>登入步驟請參考原文</li>
<li>一旦取得 role ROLE_USER 將會再次導入之前的網址 <code>/sparklr2/oauth/authorize</code></li>
<li><p>該網址一旦安裝 core Spring Security OAuth project，透過下述設定就會產生該 endpoint</p>

<p> &#8220;`
 &lt;oauth:authorization-server client-details-service-ref=&#8221;clientDetails&#8221; token-services-ref=&#8221;tokenServices&#8221;</p>

<pre><code> user-approval-handler-ref="userApprovalHandler"&gt;
 &lt;oauth:authorization-code /&gt;
 &lt;oauth:implicit /&gt;
 &lt;oauth:refresh-token /&gt;
 &lt;oauth:client-credentials /&gt;
 &lt;oauth:password /&gt;
</code></pre>

<p> &lt;/oauth:authorization-server>
 &#8220;`</p></li>
<li>其中 AuthorizationEndpoint 對應  <code>/oauth/authorize</code></li>
</ol>


<h3>透過 AuthorizationEndpoint 取得 CLIENT ROLE</h3>

<p>關於登入者可執行的操作將透過 InMemoryClientDetailsService 取得，該物件將讀取設定如下：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;oauth:client-details-service id="clientDetails"&gt;
</span><span class='line'>
</span><span class='line'>    &lt;oauth:client client-id="my-trusted-client" authorized-grant-types="password,authorization_code,refresh_token,implicit" authorities="ROLE_CLIENT, ROLE_TRUSTED_CLIENT" scope="read,write,trust" access-token-validity="60" /&gt;
</span><span class='line'>    ...    
</span><span class='line'>    &lt;oauth:client client-id="my-untrusted-client-with-registered-redirect" authorized-grant-types="authorization_code" authorities="ROLE_CLIENT" redirect-uri="http://anywhere" scope="read" /&gt;
</span><span class='line'>    
</span><span class='line'>    &lt;oauth:client client-id="tonr" resource-ids="sparklr" authorized-grant-types="authorization_code,implicit" authorities="ROLE_CLIENT" scope="read,write" secret="secret" /&gt;
</span><span class='line'>&lt;/oauth:client-details-service&gt;</span></code></pre></td></tr></table></div></figure>


<p>這裡就是 oauth 與一般使用者驗證的差別，定義的是可對 resource 的操作有哪些如 <code>read,write,trust</code>，這邊的權限設定沒有 user 的概念，只有 server 對不同 client-id 與有無 secret 的差別對 client 提供的功能有哪些，一旦確認有存在於設定檔將會取得 ClientDetails 物件。</p>

<h3>sparklr 請使用者確認是否允許該存取</h3>

<p>一旦確認 AuthorizationRequest 有取得 ClientDetails 物件，將會在被導入 <code>/oauth/confirm_access</code> 該網址的實作必須由我們自己開發的應用程式來實作，也就是 Sparklr 中的 AccessConfirmationController 進而顯示 <code>access_confirmation.jsp</code>，讓使用者確認是否允許存取</p>

<h3>確認允許，透過 PhotoController 取得照片</h3>

<p>一旦點選允許將發生下面的事情：</p>

<ol>
<li>確認 AuthorizationRequest 是有效可進行存取的。</li>
<li>透過呼叫 AuthorizationRequest 的 getResponseTypes 取得 code，不是 token</li>
<li>framework 會產生新的 authorization code，交由 approveOrDeny 方法完成之後的事情，將會從 Sparklr 導回 tonr，實際的範例網址為 <code>http://localhost:8080/tonr2/sparklr/photos;jsessionid=03B2E814391E010B3D1210241ECF6C0A?code=vqMbuf&amp;state=aTSlVl</code></li>
<li><p>OAuth2RestTemplate 與 AuthorizationCodeAccessTokenProvider 結合，從 Sparklr 取得 token，實際上，將會 request <code>/sparklr/oauth/token</code>包含下列參數：</p>

<p> &#8220;`
 {</p>

<pre><code> grant_type=’authorization_code’,
 redirect_uri=’http://localhost:8080/tonr2/sparklr/photos’,
 code=xxxx
</code></pre>

<p> }
 &#8220;`</p></li>
<li>該次呼叫會被 <code>org.springframework.security.oauth2.provider.endpoint.TokenEndpoint</code> 處理產生 OAuth2AccessToken 並且 response Bearer token。</li>
<li>一旦取得 token，Tonr 會再一次呼叫 Sparklr，這次將會傳入取得的 Bearer token 於該次請求的 header</li>
<li>透過 OAuth2AuthenticationProcessingFilter 解開 token 在由 Oauth2AuthenticationManager 確認該請求是否合法。</li>
<li>一旦確認無誤，終於可以到達 PhotoController 取得照片的資源。</li>
</ol>


<p>步驟很多，也許有說明不清楚的地方，不過確實把 oauth 的運作詳細走過一遍，希望可以幫助到有需要的人，上述範例是使用 xml 來定義安全性相關的設定，下一篇將進一步說明使用 spring-boot 透過 java config(java 物件)來定義 oauth 過程會精簡很多，筆者也是先瞭解最基本得 xml 設定，才能完成 java config 型式的應用，若有需要，可以先參考下列專案，利用 java config 完成 Spring Security 設定：</p>

<ul>
<li><a href="https://github.com/spring-projects/spring-security-javaconfig">Spring Security Java Config</a>: 各種使用 java config 的安全性設定</li>
<li><a href="https://github.com/spring-projects/spring-security-oauth-javaconfig">spring-security-oauth-javaconfig</a>: 針對 oauth 的 java config 設定，算是還在概念階段</li>
</ul>


  </div>


  

  <hr>
  <div class="post-meta">
    
    <span>








  




<i class="mini-ico-calendar"></i><time datetime="2014-01-19T00:00:00+08:00" pubdate data-updated="true">Jan 19<span>th</span>, 2014</time></span>

    <span><i class="mini-ico-bookmark"></i><a rel="bookmark" href="/blog/2014/01/19/Spring-Security-oauth2/"></a></span>
    

    
    <span><i class="mini-ico-comment"></i><a class="comments-link" href="/blog/2014/01/19/Spring-Security-oauth2/#disqus_thread">View comments &raquo;</a></span>
    

    

  </div>

  



</div>
    </div>
    
      










    <div class="post " >
      
<div class="post-content">


  <hr>
  
  <div class="post-title">
    
<h1 class="entry-title">

<a href="/blog/2014/01/19/Spring-Security-Basic-Authentication-with-Ajax-request/">Spring Security Basic Authentication With Ajax Request 失敗處理</a>

</h1>

  </div>
  

  <hr>


  <div class="post-description">
    <p>當你在製作一個 rest service，提供 API 另外部的程式存取，比如說網頁中的 ajax request，且必須要有基本的安全性防護，在 java base 底下我們可以引入 Spring Security 來幫我們處理安全性的大小事。</p>

<p>關於安全性驗證的方式，可參考官方的文件:<a href="http://docs.spring.io/spring-security/site/docs/3.0.x/reference/introduction.html">Spring Security doc</a></p>

<p>基於 rest service 的特性，既然是提供給第三方軟體呼叫，我們就不希望還需要 login 頁面來登入 rest service，可以的話當然希望在進行請求時就驗證存取權限，所以我們需要使用的是 <a href="http://docs.spring.io/spring-security/site/docs/3.0.x/reference/basic.html">Basic Authentication</a>。</p>

<p>簡單來說 Basic Authentication 就是將驗證資訊透過 http headers 傳遞，交由 server 驗證之後，返回通過或失敗，範例的 request 呼叫如下：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>function make_base_auth(user, password) {
</span><span class='line'>    var tok = user + ':' + password;
</span><span class='line'>    var hash = $.base64.encode(tok);
</span><span class='line'>    return "Basic "+hash;
</span><span class='line'>}
</span><span class='line'>$.ajax("http://localhost:8080/test/sendMsg", {
</span><span class='line'>    type: "GET",
</span><span class='line'>    success: function(){
</span><span class='line'>        alert("OK");
</span><span class='line'>    },
</span><span class='line'>    xhrFields: {
</span><span class='line'>        withCredentials: true
</span><span class='line'>    }, 
</span><span class='line'>    beforeSend: function (xhr) {
</span><span class='line'>        xhr.setRequestHeader('Authorization', 
</span><span class='line'>            make_base_auth("user", "password"));
</span><span class='line'>    }
</span><span class='line'>});</span></code></pre></td></tr></table></div></figure>


<p>其中 Authorization 的值必須以 Basic 開頭，接著將 username:password 透過 base64 編碼，上述 <code>make_base_auth("user", "password")</code> 回傳的內容為： <code>Basic dXNlcjpwYXNzd29yZA==</code>，並且需要設定 <code>withCredentials</code>，表示包含驗證資訊。</p>

<p>前端的呼叫程式準備好了以後，我們需要對後端的 http 網路存取權限進行設定，rest server 與呼叫端屬於 cross domain 的呼叫，因此需要設置 CorsFilter，如下：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>@Component
</span><span class='line'>public class CorsFilter extends OncePerRequestFilter
</span><span class='line'>{
</span><span class='line'>
</span><span class='line'>    @Override
</span><span class='line'>    protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain)
</span><span class='line'>            throws ServletException, IOException
</span><span class='line'>    {
</span><span class='line'>        response.addHeader("Access-Control-Allow-Origin", "http://192.168.0.100:8080");
</span><span class='line'>        response.addHeader("Access-Control-Allow-Methods", "HEAD, GET, POST, OPTIONS");
</span><span class='line'>        response.addHeader("Access-Control-Allow-Headers","Authorization, Content-Type, Origin, Accept");
</span><span class='line'>        response.addHeader("Access-Control-Max-Age", "1800");
</span><span class='line'>        response.addHeader("Access-Control-Allow-Credentials", "true");
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>        filterChain.doFilter(request, response);
</span><span class='line'>    }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>rest server 使用 <a href="http://projects.spring.io/spring-boot/">spring-boot</a> 製作，傳統建立 filter 時需要在維護 web.xml，在這裡只要註記為 <code>@Component</code>，且 <code>extends OncePerRequestFilter</code>，服務啟動時 spring 會自動配置 filter，透過設置 Access-Control-* 的相關屬性，我們可以限制對 server 的存取限制。</p>

<p>接著，我們需要定義 Security Config：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>@EnableWebSecurity
</span><span class='line'>@Configuration
</span><span class='line'>public class SecurityConfig extends WebSecurityConfigurerAdapter {
</span><span class='line'>    @Override
</span><span class='line'>    protected void configure(HttpSecurity http) throws Exception {
</span><span class='line'>        http.authorizeRequests()
</span><span class='line'>                .antMatchers("/test/sendMsg").hasRole("USER")
</span><span class='line'>                .anyRequest().authenticated();
</span><span class='line'>        http.httpBasic();
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    @Override
</span><span class='line'>    protected void configure(AuthenticationManagerBuilder authManagerBuilder) throws Exception {
</span><span class='line'>        authManagerBuilder.inMemoryAuthentication()
</span><span class='line'>                .withUser("user").password("password").roles("USER");
</span><span class='line'>    }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>在 <code>configure(HttpSecurity http)</code> 我們定義了 <code>/test/sendMsg</code> 的存取者必須要有 <code>USER</code> 的權限，且驗證方式使用 <code>Basic</code>；在 <code>configure(AuthenticationManagerBuilder authManagerBuilder)</code> 定義使用者帳號。</p>

<p>如此一來，程式算是準備好，我們可以利用 <code>curl</code> 指令來驗證：</p>

<p><code>curl --url http://localhost:8080/test/sendMsg -H 'Authorization: Basic dXNlcjpwYXNzd29yZA=='</code></p>

<p>可以正常取得 response，但是一旦我們透過 ajax 的方式存取，總會跳出下面的畫面：</p>

<p><img src="https://lh6.googleusercontent.com/-mUoOv_pKbzQ/UsJObr558rI/AAAAAAAAL9s/pni0SJbDEyQ/s0/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7+2013-12-31+%E4%B8%8B%E5%8D%8812.55.37.png" title="螢幕快照 2013-12-31 下午12.55.37.png" alt="enter image description here" /></p>

<p>這是我們不想要的，且與程式邏輯不符，畢竟我們在 CorsFilter 定義了允許 <code>Authorization</code> 的 header 卻沒有通過驗證，並且在 <code>curl</code> 的模式下是可正常存取。</p>

<p>且既然是提供給第三方軟體呼叫，對使用者而言，一定不知道遠端 rest server 的存取密碼，為了跳過這個帳號密碼驗證步驟，查了相關處理程式 <code>BasicAuthenticationEntryPoint</code> 的原始碼說明：</p>

<p><a href="http://git.springsource.org/~rwinch/spring-security/rwinchs-spring-security/blobs/bf9d4a97470c679008ef6ce42681e3d0c1992636/web/src/main/java/org/springframework/security/web/authentication/www/BasicAuthenticationEntryPoint.java">BasicAuthenticationEntryPoint.java</a></p>

<blockquote><p> Once a user agent is authenticated using BASIC authentication, logout requires that the browser be closed or an unauthorized (401) header be sent.</p></blockquote>

<p>也就是說預設的處理方式，一律會回傳 <code>unauthorized (401)</code>，處理的原始碼如下：</p>

<p>&#8220;
public void commence(HttpServletRequest request, HttpServletResponse response, AuthenticationException authException)</p>

<pre><code>throws IOException, ServletException {
response.addHeader("WWW-Authenticate", "Basic realm=\"" + realmName + "\"");
response.sendError(HttpServletResponse.SC_UNAUTHORIZED, authException.getMessage());
</code></pre>

<p>}
&#8220;</p>

<p>所以無論你怎麼調整 CorsFilter 或是 ajax request 參數，就是沒有辦法通過 http 驗證，總是跳出 dialog 需要驗證帳號與密碼，檢查 request method 雖然設置的是 <code>GET</code> 但總是傳出 <code>OPTIONS</code>。</p>

<p>至於為什麼，可參考下列文章：</p>

<p><a href="http://stackoverflow.com/questions/11199426/jquery-cors-json-without-padding-and-authentication-issues">jQuery, CORS, JSON (without padding) and authentication issues</a></p>

<p>文中提到：</p>

<blockquote><p>Basically, because I need authentication, the GET request is sending an Authorization header. However, this is not a &#8220;simple&#8221; header, and so the browser is sending a pre-flight request (the OPTIONS). This preflight request doesn&#8217;t have any authentication, though, and so the server was rejecting it. The &#8220;solution&#8221; was to set the server to let OPTIONS request not require authentication, and report an HTTP status of 200 to it.</p>

<p>Reference: http://www.kinvey.com/blog/item/61-kinvey-adds-cross-origin-resource-sharing-cors</p></blockquote>

<p>也就是說，瀏覽器檢查有驗證資訊，就不是&#8221;簡單&#8221;的 http request，所以會先送出一個 pre-flight request，也就是 <code>OPTIONS</code>，該 OPTIONS 就不會有驗證資訊，以致於 server 就會拒絕請求，也就呼應為什麼 <code>curl</code> 的情況下可以正常請求，為了解決此問題，就必須要讓 server 能夠接受 OPTIONS 可包含 authentication 的 header 來進行驗證。</p>

<p>上述的說明在一開始看到時還不清楚處理邏輯，真要親身體驗才能了解，花了一天的時間的重覆嘗試，總算讓我找到解法，參考下列文章：</p>

<p><a href="https://github.com/davidtinker/grails-cors/issues/12">Basic Auth filter authenticates OPTIONS requests and breaks CORS</a></p>

<p>從上面關於瀏覽器對於&#8221;不簡單&#8221;的 request 的敘述，瀏覽器的處理流程會是：</p>

<ol>
<li>先送出一個 OPTIONS 的 request 進行驗證</li>
<li>如果 OPTIONS 的 request 不是回傳 401 UNAUTHORIZED 會接著送出在 ajax 定義的 http mathod 的 request</li>
</ol>


<p>會這樣處理，是因為瀏覽器預設是一旦檢查第一步驟沒有通過，就會跳出 dialog 請使用者輸入帳號密碼(開啟 withCredentials 的前提下)，一旦通過，就會將驗證資訊存於 cookies，接著進入第二步驟時，會將已存在 cookies 的驗證資訊加入到第二步驟的 header，之後再重覆請求時就會一直有效，直到 cookies 過期。</p>

<p>有這樣的認知後，在看上面連結中程式部分的解法時就比較能夠理解。</p>

<p>透過繼承 <code>BasicAuthenticationEntryPoint</code> 覆寫 <code>commence</code>，判斷如果是 <code>Preflight</code> 依據傳入的 http method 是否為 <code>OPTIONS</code> 來判斷，若是，則回傳 <code>HttpServletResponse.SC_NO_CONTENT</code>。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>if(isPreflight(request)){
</span><span class='line'>    response.setStatus(HttpServletResponse.SC_NO_CONTENT);</span></code></pre></td></tr></table></div></figure>


<p>因為 OPTIONS 只是瀏覽器為了驗證進行的 request，並不是我們主要的 request 所以將其設為 SC_NO_CONTENT(204)，沒有內容，但沒有失敗，一旦瀏覽器接收到沒有失敗的情形，就會進行主要的 request 請求，此時主要的 request 就會包含 Authentication 的資訊，接著看下面一個判斷式。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>if (isRestRequest(request)) {
</span><span class='line'>    response.sendError(HttpServletResponse.SC_UNAUTHORIZED, "Unauthorized");</span></code></pre></td></tr></table></div></figure>


<p>再來，這邊限制了如果有 <code>X-Requested-With ,XMLHttpRequest</code> 這樣的 header 就直接回傳 <code>SC_UNAUTHORIZED</code>(401)， 有沒有必要，就看服務的性質與需求，可以針對各種狀況，設定不允許存取的條件，最後其他狀況就走一般的處理模式了，完整的程式碼如下：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>public class AjaxAwareLoginUrlAuthenticationEntryPoint extends
</span><span class='line'>        BasicAuthenticationEntryPoint {
</span><span class='line'>
</span><span class='line'>    private static final RequestMatcher requestMatcher = new ELRequestMatcher(
</span><span class='line'>            "hasHeader('X-Requested-With','XMLHttpRequest')");
</span><span class='line'>
</span><span class='line'>    public CustomAuthenticationEntryPoint() {
</span><span class='line'>        super();
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    public CustomAuthenticationEntryPoint(String realmName) {
</span><span class='line'>        setRealmName(realmName);
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    @Override
</span><span class='line'>    public void commence(final HttpServletRequest request, final HttpServletResponse response, final AuthenticationException authException) throws IOException, ServletException {
</span><span class='line'>
</span><span class='line'>        if(isPreflight(request)){
</span><span class='line'>            response.setStatus(HttpServletResponse.SC_NO_CONTENT);
</span><span class='line'>        } else if (isRestRequest(request)) {
</span><span class='line'>            response.sendError(HttpServletResponse.SC_UNAUTHORIZED, "Unauthorized");
</span><span class='line'>        } else {
</span><span class='line'>            super.commence(request, response, authException);
</span><span class='line'>        }
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    /**
</span><span class='line'>     * Checks if this is a X-domain pre-flight request.
</span><span class='line'>     * @param request
</span><span class='line'>     * @return
</span><span class='line'>     */
</span><span class='line'>    private boolean isPreflight(HttpServletRequest request) {
</span><span class='line'>        return "OPTIONS".equals(request.getMethod());
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    /**
</span><span class='line'>     * Checks if it is a rest request
</span><span class='line'>     * @param request
</span><span class='line'>     * @return
</span><span class='line'>     */
</span><span class='line'>    protected boolean isRestRequest(HttpServletRequest request) {
</span><span class='line'>        return requestMatcher.matches(request);
</span><span class='line'>    }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>一旦定義好 AuthenticationEntryPoint 在文章中的使用的方式是用 grails 的語法與定義檔：</p>

<blockquote><p>Open resources.groovy and add the following lines:</p></blockquote>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>beans = {
</span><span class='line'>
</span><span class='line'>    basicAuthenticationEntryPoint(CustomAuthenticationEntryPoint) { bean -&gt;
</span><span class='line'>        realmName = 'Your Realm'
</span><span class='line'>    }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>spring boot 的情形，我們只要修改一開始建立的 SecuityConfig：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>@Override
</span><span class='line'>protected void configure(HttpSecurity http) throws Exception {
</span><span class='line'>
</span><span class='line'>    AjaxAwareLoginUrlAuthenticationEntryPoint ajaxAwareLoginUrlAuthenticationEntryPoint = new AjaxAwareLoginUrlAuthenticationEntryPoint();
</span><span class='line'>    ajaxAwareLoginUrlAuthenticationEntryPoint.setRealmName("testAp");
</span><span class='line'>    http.httpBasic().authenticationEntryPoint(ajaxAwareLoginUrlAuthenticationEntryPoint);
</span><span class='line'>
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>新增客製的 <code>ajaxAwareLoginUrlAuthenticationEntryPoint</code>，設置 RealmName，並且加入 <code>httpBasic().authenticationEntryPoint</code> 即可，省去繁瑣的 xml 定義，程式更加的精簡。</p>

<p>實際執行，我們可以看到，一次 ajax 呼叫，有兩個 request：</p>

<p><img src="https://lh6.googleusercontent.com/--XnQ7f4ItTQ/UsKALIrzHOI/AAAAAAAAL-E/cbnNgTDJYP4/s0/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7+2013-12-31+%E4%B8%8B%E5%8D%883.53.51.png" title="螢幕快照 2013-12-31 下午3.53.51.png" alt="enter image description here" /></p>

<p>且第一次呼叫的 http method 為 OPTIONS，http code 為 204，第二次才是主要的 ajax request，在看下圖，為 header 資訊：</p>

<p><img src="https://lh4.googleusercontent.com/-JcEBuYSzsSY/UsKAneA8uuI/AAAAAAAAL-Q/s1Tlly239K4/s0/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7+2013-12-31+%E4%B8%8B%E5%8D%883.54.38.png" title="螢幕快照 2013-12-31 下午3.54.38.png" alt="enter image description here" /></p>

<p>可以看到 <code>Authorization</code> 已有存在 header，且 request 正常，已有正確執行 rest server 的服務。</p>

<p>這問題著實困擾了我好久，對於不是 IT 背景的我，理解花了好多時間，不過也總算對網路安全，還有驗證的方式，以及瀏覽器對於安全性驗證的處理邏輯有一定的認知，不過畢竟是新鮮的理解，如果有說錯還請不吝指教。</p>

  </div>


  

  <hr>
  <div class="post-meta">
    
    <span>








  




<i class="mini-ico-calendar"></i><time datetime="2014-01-19T00:00:00+08:00" pubdate data-updated="true">Jan 19<span>th</span>, 2014</time></span>

    <span><i class="mini-ico-bookmark"></i><a rel="bookmark" href="/blog/2014/01/19/Spring-Security-Basic-Authentication-with-Ajax-request/"></a></span>
    

    
    <span><i class="mini-ico-comment"></i><a class="comments-link" href="/blog/2014/01/19/Spring-Security-Basic-Authentication-with-Ajax-request/#disqus_thread">View comments &raquo;</a></span>
    

    

  </div>

  



</div>
    </div>
    
      










    <div class="post " >
      
<div class="post-content">


  <hr>
  
  <div class="post-title">
    
<h1 class="entry-title">

<a href="/blog/2014/01/19/Spring+boot-memory-useage/">Spring Boot: 監控 Memory Useage & 執行 GC</a>

</h1>

  </div>
  

  <hr>


  <div class="post-description">
    <p>參考下面連結：<a href="http://xantorohara.blogspot.tw/2013/11/spring-boot-memory-usage.html">Spring-boot memory usage</a></p>

<p>因為 spring boot 可使用 jar 檔直接運行，不需要打包成 war，也不需要實體 tomcat，實際上，spring boot 使用的是 embedded tomcat，整個專案打包後的大小非常小，使得記憶體可用空間也能夠更多。</p>

<p>文中利用下面的 controller 來輸出記憶體使用量：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>import org.springframework.stereotype.Controller;
</span><span class='line'>import org.springframework.web.bind.annotation.RequestMapping;
</span><span class='line'>import org.springframework.web.bind.annotation.RequestMethod;
</span><span class='line'>import org.springframework.web.bind.annotation.ResponseBody;
</span><span class='line'>
</span><span class='line'>@Controller
</span><span class='line'>public class AdminController {
</span><span class='line'>
</span><span class='line'>    @RequestMapping(value = "/admin/mem", method = {RequestMethod.GET}
</span><span class='line'>            , produces = "text/html;charset=UTF-8")
</span><span class='line'>    @ResponseBody
</span><span class='line'>    public String mem() {
</span><span class='line'>        long max = Runtime.getRuntime().maxMemory();
</span><span class='line'>        long total = Runtime.getRuntime().totalMemory();
</span><span class='line'>        long free = Runtime.getRuntime().freeMemory();
</span><span class='line'>        long used = total - free;
</span><span class='line'>
</span><span class='line'>        return String.format("Memory:\n" +
</span><span class='line'>                "max: %,d bytes\n" +
</span><span class='line'>                "total: %,d bytes\n" +
</span><span class='line'>                "free: %,d bytes\n" +
</span><span class='line'>                "used: %,d bytes\n",
</span><span class='line'>                max, total, free, used);
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    @RequestMapping(value = "/admin/rungc" , method = RequestMethod.GET)
</span><span class='line'>    @ResponseBody
</span><span class='line'>    public String rungc() {
</span><span class='line'>        Runtime.getRuntime().gc();
</span><span class='line'>        return "Run GC finish";
</span><span class='line'>    }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>自己的專案，包含了 spring security、jdbc、rest service、以及 rabbitmq client
執行的結果如下：</p>

<blockquote><p>剛啟動時記憶體使用量
(http://localhost:8080/admin/mem):
max:    1,908,932,608 bytes
total:    372,768,768 bytes
free:     274,485,040 bytes
used:      98,283,728 bytes</p></blockquote>

<hr />

<blockquote><p>執行GC後的使用量
(http://localhost:8080/admin/rungc):
max: 1,908,932,608 bytes
total: 374,865,920 bytes
free:  346,690,128 bytes
used:   28,175,792 bytes</p></blockquote>

<p>還不賴！</p>

  </div>


  

  <hr>
  <div class="post-meta">
    
    <span>








  




<i class="mini-ico-calendar"></i><time datetime="2014-01-19T00:00:00+08:00" pubdate data-updated="true">Jan 19<span>th</span>, 2014</time></span>

    <span><i class="mini-ico-bookmark"></i><a rel="bookmark" href="/blog/2014/01/19/Spring+boot-memory-useage/"></a></span>
    

    
    <span><i class="mini-ico-comment"></i><a class="comments-link" href="/blog/2014/01/19/Spring+boot-memory-useage/#disqus_thread">View comments &raquo;</a></span>
    

    

  </div>

  



</div>
    </div>
    
      










    <div class="post " >
      
<div class="post-content">


  <hr>
  
  <div class="post-title">
    
<h1 class="entry-title">

<a href="/blog/2014/01/19/SQL-state-HY010/">SQL State [HY010]; Error Code [0]; Invalid State, the Connection Object Is Closed 處理筆記</a>

</h1>

  </div>
  

  <hr>


  <div class="post-description">
    <p>之前曾經遇到過，最近又來了&#8230;</p>

<p>果然該還的還是要還，因此這次要詳細記錄處理過程，希望以後再發生可以更快釐清問題。</p>

<p>首先需要先確定發生可能原因，google 了一下目前比較明確的錯誤狀況如下：</p>

<ol>
<li>到了連線 timeout 時間</li>
<li>drive 的問題</li>
<li>或是 database server 被重啟</li>
</ol>


<p>我查了一下預設的 connection pool 的 timeout 時間有 30000 ms，所以第一項先不考慮。</p>

<p>drive 問題目前發生問題的是 jtds 1.3.1，有人說換換看 ms sql 所提供的 drive，在 sql 2008、O.S. 為 64 位元的情況會比較沒問題，well 姑且試試看。</p>

<p>檢視 database 的 log 記錄，似乎有重啟的狀況，如下圖：</p>

<p><img src="https://lh4.googleusercontent.com/-ZQwS21llDr4/Us0VNJxSjwI/AAAAAAAAMA4/BED3lh6m6vo/s0/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7+2014-01-08+%E4%B8%8B%E5%8D%885.05.15.png" title="螢幕快照 2014-01-08 下午5.05.15.png" alt="enter image description here" /></p>

<p>在持續觀察中發現確實隔天早上資料庫被重啟(os 重新啟動)，另外一個可調整的地方就是設置 connection pool 的 setTestOnBorrow：取出 pool 中的連線時進行驗證，若沒有通過則會在取出新的連線，這應該是我們要的參數，經過下列測試步驟：</p>

<h2>未設置 testOnBorrow 的情形</h2>

<ol>
<li>啟動服務，進行資料查詢正常</li>
<li>暫停 sql server</li>
<li>暫停中進行資料查詢，吐出訊息 <code>SQLServerException: Broken pipe</code></li>
<li>啟動 sql server</li>
<li>再次進行查詢，吐出訊息 <code>SQL state [null]; error code [0]; 連接已關閉</code></li>
</ol>


<h2>有設置 testOnBorrow 的情形</h2>

<ol>
<li>啟動服務，進行資料查詢正常</li>
<li>暫停 sql server</li>
<li>暫停中進行資料查詢，吐出訊息 <code>SQLServerException: Broken pipe</code></li>
<li>啟動 sql server</li>
<li>再次進行查詢，資料查詢正常</li>
</ol>


<p>這樣一來即使遠端連結的資料庫主機重啟，或是關閉的情形，一旦該主機重新上線，我們的應用程式也不用重開令 pool 重新連線，才不會總是鬼打牆，服務明明好好得但就是會出現連線異常，檢視遠端 db 主機也在線上，殊不知曾經被重啟過。</p>

<p>另外 testOnBorrow 需要搭配 validationQuery 使用，可參考下面連結：<a href="https://wiki.shibboleth.net/confluence/plugins/viewsource/viewpagesrc.action?pageId=4358588">Database Connectors</a>，最下方的 Database Reference Table 有各個不同 databse 的 validationQuery 可以參考。</p>

<p>一件落著！</p>

<p>不過我的測試案例出現的是 <code>SQL state [null];</code> 而不是 <code>SQL state [HY010];</code>，還是要在觀察一下。</p>

<p>若有朋友有關於此問題有處理經驗或建議，也請指教，感謝！</p>

  </div>


  

  <hr>
  <div class="post-meta">
    
    <span>








  




<i class="mini-ico-calendar"></i><time datetime="2014-01-19T00:00:00+08:00" pubdate data-updated="true">Jan 19<span>th</span>, 2014</time></span>

    <span><i class="mini-ico-bookmark"></i><a rel="bookmark" href="/blog/2014/01/19/SQL-state-HY010/"></a></span>
    

    
    <span><i class="mini-ico-comment"></i><a class="comments-link" href="/blog/2014/01/19/SQL-state-HY010/#disqus_thread">View comments &raquo;</a></span>
    

    

  </div>

  



</div>
    </div>
    
      










    <div class="post " >
      
<div class="post-content">


  <hr>
  
  <div class="post-title">
    
<h1 class="entry-title">

<a href="/blog/2014/01/19/Grails-migrations-database/">Grails Migrations: Database 的版本控管</a>

</h1>

  </div>
  

  <hr>


  <div class="post-description">
    <p>說到版本控管，就一定跟版本顯示，更新舊有版本有關，在程式碼部分使用版本控管已經習以為常，但通常一個應用程式或是專案從來就不只有程式碼，還有 datbase schema 的維護，偏偏 datbase 的版本升級沒有像程式碼控管那樣的簡單，也沒有類似 SVN 或是 GIT 的版本控管軟體。</p>

<p>不過，筆者最近在開發 grails 時發現了一個套件：<a href="http://grails.org/plugin/database-migration">Grails Database Migration Plugin</a>，其運作方式跟版本控管有異曲同工之妙，簡單但是有效的進行 datbase schema 版控。</p>

<p>下列文章在使用 Grails Migration 非常有參考價值，若有需要可以看看：</p>

<ul>
<li><a href="http://grails-plugins.github.io/grails-database-migration/docs/manual/guide/introduction.html">Database Migration Plugin - Reference Documentation</a></li>
<li><a href="http://fbflex.wordpress.com/2011/01/19/working-with-the-grails-database-migration-plugin/">Working with the Grails Database Migration Plugin</a></li>
<li><a href="http://wpgreenway.com/posts/grails-db-migration-tutorial/">Grails Db Migration Tutorial</a></li>
</ul>


<p>在開始說明前需要先進行 dataSource 的調整。</p>

<h2>定義 dataSource</h2>

<p>grails 預設的 domain 管理使用的是 gorm 技術，也就是常見的 orm mapping，因此，一般預設會定義 dbCreate = &#8220;update&#8221;，也就是一旦檢查 domain 物件有調整，會自動檢查並且更新，使用 Migration 我們就不希望 orm mapping 介入因此我們在定義 dataSource 的地方設定 <code>dbCreate = ""</code>，也就是關閉自動更新的機制，設定檔如下：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>development {
</span><span class='line'>    dataSource {
</span><span class='line'>        dbCreate = "" // one of 'create', 'create-drop', 'update', 'validate', ''
</span><span class='line'>        pooled = true
</span><span class='line'>        driverClassName = "com.mysql.jdbc.Driver"
</span><span class='line'>        dialect = org.hibernate.dialect.MySQL5InnoDBDialect
</span><span class='line'>        username = ""
</span><span class='line'>        password = ""
</span><span class='line'>        url = "jdbc:mysql://localhost/test?useUnicode=true&characterEncoding=UTF8&zeroDateTimeBehavior=convertToNull"
</span><span class='line'>    }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>一定有讀者會有疑慮使用 orm 技術就可以幫我們自動更新 schema 為什麼還要使用 migrations ? 幾點如下：</p>

<ol>
<li>migrations 有版本記錄與控管，orm update 沒有</li>
<li>migrations 可以偵測到 PK、FK、限制式的調整，orm update 沒辦法</li>
<li>migrations 可以偵測到欄位的刪除，orm update 沒辦法</li>
<li>migrations 可以自定更新 sql 語法，並且加入版本控管，orm update 沒辦法</li>
</ol>


<p>如果你的應用程式不會停止更新變動，那 migrations 才有可能涵蓋所有需求。</p>

<p>有了上述了解與設定後，首先要為我們的資料庫建立第一版的版控內容，可以想像成版本控制的初始專案或是 git init。</p>

<h2>初始資料庫版控</h2>

<p>假設我們有個 domain 定義如下：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class Part {
</span><span class='line'>    String name
</span><span class='line'>    String title
</span><span class='line'>    String description
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>    static constraints = {
</span><span class='line'>        name blank: false, unique: true
</span><span class='line'>        title blank: false
</span><span class='line'>        description nullable: true, empty: true
</span><span class='line'>
</span><span class='line'>    }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>一旦在 grails 建立了 domain 之後，我們可以透過下列語法產生最一開始的資料庫版控記錄檔： <code>changelog.groovy</code></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>grails dev dbm-generate-gorm-changelog changelog.groovy </span></code></pre></td></tr></table></div></figure>


<p>該指令指的是透過 domain 產生建立資料庫的相關語法 如下：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>databaseChangeLog = {
</span><span class='line'>
</span><span class='line'>  changeSet(author: "Spooky (generated)", id: "1389679387050-1") {
</span><span class='line'>      createTable(tableName: "part") {
</span><span class='line'>          column(autoIncrement: "true", name: "id", type: "bigint") {
</span><span class='line'>              constraints(nullable: "false", primaryKey: "true", primaryKeyName: "partPK")
</span><span class='line'>          }
</span><span class='line'>
</span><span class='line'>          column(name: "version", type: "bigint") {
</span><span class='line'>              constraints(nullable: "false")
</span><span class='line'>          }
</span><span class='line'>
</span><span class='line'>          column(name: "description", type: "varchar(255)")
</span><span class='line'>
</span><span class='line'>          column(name: "name", type: "varchar(255)") {
</span><span class='line'>              constraints(nullable: "false")
</span><span class='line'>          }
</span><span class='line'>
</span><span class='line'>          column(name: "title", type: "varchar(255)") {
</span><span class='line'>              constraints(nullable: "false")
</span><span class='line'>          }
</span><span class='line'>      }
</span><span class='line'>  }
</span><span class='line'>
</span><span class='line'>  changeSet(author: "Spooky (generated)", id: "1389679387050-2") {
</span><span class='line'>      createIndex(indexName: "name_uniq_1389679387009", tableName: "part", unique: "true") {
</span><span class='line'>          column(name: "name")
</span><span class='line'>      }
</span><span class='line'>  }
</span><span class='line'>}
</span></code></pre></td></tr></table></div></figure>


<p>一旦建立完成，我們可以在我們 DB server 先建立好空的資料庫，透過下面指令產生一個初始的 database 包含上面 changelog.groovy 的變動：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>grails dev dbm-update</span></code></pre></td></tr></table></div></figure>


<p>初始資料庫建好之後，我們可以使用 sql client 軟體來看一下 table 的結構，如下圖:</p>

<p><img src="https://lh6.googleusercontent.com/-LHDhbqc-ikY/UtTWMawYxnI/AAAAAAAAMB0/QzxhMNG5QJI/s0/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7+2014-01-14+%E4%B8%8B%E5%8D%882.15.25.png" title="螢幕快照 2014-01-14 下午2.15.25.png" alt="enter image description here" /></p>

<p>圖中的 DATABASECHANGELOG table 記錄的就是目前 database 的版本記錄，migrations plugin 就是透過該 table 比對目前 db 執行到 changelog 裡的哪些調整，不存在的才執行，如此一來即使你的應用程式會 deploy 到不同主機且 db 的版本不一致的情形，透過該 table 就可以知道每個 db 目前的版本狀況進而讓  migration plugin 幫你更新到最新的 database 版本。</p>

<p>對於初始 db 以及版本資訊 的建立有了解後，接著要說明調整欄位後，如何將調整結果更新的到 db。</p>

<h2>調整欄位後更新 database</h2>

<p>假設我們將一開始建立的 domain 調整 index，以及去掉以及加入欄位的 nullable 限制式：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class Part {
</span><span class='line'>    String name
</span><span class='line'>    String title
</span><span class='line'>    String description
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>    static constraints = {
</span><span class='line'>        name blank: false, unique: 'title' // 新增 PK
</span><span class='line'>        title nullable: true //原本 title blank: false
</span><span class='line'>        //description nullable: true, empty: true
</span><span class='line'>    }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>一旦 domain 調整完成後，我們可以進行比對目前 database schema 與 domain 的差異，透過下列語法：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>grails dev dbm-gorm-diff 1.0.1.groovy -add</span></code></pre></td></tr></table></div></figure>


<p>因為版本控制的概念是要一直延續，且有每階段的調整，我們將第二次的調整儲存於另外的的檔案叫做 <code>1.0.1.groovy</code>，其產生的結果如下：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>databaseChangeLog = {
</span><span class='line'>
</span><span class='line'>  changeSet(author: "Spooky (generated)", id: "1389681182984-1") {
</span><span class='line'>      addNotNullConstraint(columnDataType: "varchar(255)", columnName: "description", tableName: "part")
</span><span class='line'>  }
</span><span class='line'>
</span><span class='line'>  changeSet(author: "Spooky (generated)", id: "1389681182984-2") {
</span><span class='line'>      dropNotNullConstraint(columnDataType: "varchar(255)", columnName: "title", tableName: "part")
</span><span class='line'>  }
</span><span class='line'>
</span><span class='line'>  changeSet(author: "Spooky (generated)", id: "1389681182984-3") {
</span><span class='line'>      dropIndex(indexName: "name_uniq_1389679387009", tableName: "part")
</span><span class='line'>  }
</span><span class='line'>
</span><span class='line'>  changeSet(author: "Spooky (generated)", id: "1389681182984-4") {
</span><span class='line'>      createIndex(indexName: "unique_name", tableName: "part", unique: "true") {
</span><span class='line'>          column(name: "title")
</span><span class='line'>
</span><span class='line'>          column(name: "name")
</span><span class='line'>      }
</span><span class='line'>  }
</span><span class='line'>}
</span></code></pre></td></tr></table></div></figure>


<p>而指令中的 <code>-add</code> 指的是將上面檔案 includ 到 changelog.groovy，在該檔案新增一行程式：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>include file: '1.0.1.groovy'</span></code></pre></td></tr></table></div></figure>


<p>如此，我們在執行 dbm-update 時，會連著第二次更新一並檢查，再一次執行下述指令：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>grails dev dbm-update</span></code></pre></td></tr></table></div></figure>


<p>在查看一次 DATABASECHANGELOG，如下圖：</p>

<p><img src="https://lh5.googleusercontent.com/-glR-DMMN88k/UtTbuyjNQ2I/AAAAAAAAMCI/TwMLXz_CPS8/s0/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7+2014-01-14+%E4%B8%8B%E5%8D%882.38.38.png" title="螢幕快照 2014-01-14 下午2.38.38.png" alt="enter image description here" /></p>

<p>可以看到 changelog 又有新的資料，表示資料庫已更新到最新的狀態。</p>

<p>不過實際狀況可能會有執行失敗的情形，怎麼辦？該 plugin 提供了 rollback 的機制。</p>

<h2>取消更新</h2>

<p>我們可以透過下列語法將更新還原</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>grails dev dbm-rollback-count 1</span></code></pre></td></tr></table></div></figure>


<p>後面的數字表示要退回的更新步驟，需要注意的是 rollback 不一定能成功，畢竟實際狀況是複雜的，可以的話竟量測試完善，你也可以客製 rollback 要執行的語法，可參考最後的 [客製資料庫更新語法]。</p>

<p>當然，除了新專案可以使用 migration，我們也希望舊專案也能納入控管，接著說明如何升級舊有的 database</p>

<h2>將既有的 database 升級</h2>

<p>首先設定一組要升級的 database 連線參數，需要放在 dataSource.groovy，不可以放在外部設定檔，如 <code>.grails/appname-config.groovy</code>，筆者一開始測試就是定義在外部設定檔一直無法成功，設定如下：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>dbToUpdate {
</span><span class='line'>    dataSource {
</span><span class='line'>        dbCreate = ""
</span><span class='line'>        driverClassName = "com.mysql.jdbc.Driver"
</span><span class='line'>        dialect = org.hibernate.dialect.MySQL5InnoDBDialect
</span><span class='line'>        username = ""
</span><span class='line'>        password = ""
</span><span class='line'>        url = "jdbc:mysql://localhost/oldDatabase?useUnicode=true&characterEncoding=UTF8&zeroDateTimeBehavior=convertToNull"
</span><span class='line'>    }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>接著執行</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>grails dev dbm-diff dbToUpdate newChangelog.groovy</span></code></pre></td></tr></table></div></figure>


<p>該指令會以一開始定義的 dev datasource，跟 dbToUpdate datasource 指令的資料庫進行差異比對，並且將差異差異寫入 newChangelog.groovy 檔案。</p>

<p>一旦差異產生好後，接著要將 dbToUpdate 更新到跟 dev datasource 指定的 schema 一樣到最新狀態</p>

<p>在開始執行更新之前，需要先設定 config.groovy 新增下面的參數：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>grails.plugin.databasemigration.changelogFileName = newChangelog.groovy</span></code></pre></td></tr></table></div></figure>


<p>告訴 migration 在執行 dbm-update 時參考 db 跟 db 之間的差異檔 <code>newChangelog.groovy</code></p>

<p>如此一來我們就可以執行下面指令進行舊資料庫升級：</p>

<blockquote><p>注意：執行下面語法時，請先備份舊有資料庫</p></blockquote>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>grails -Dgrails.env=dbToUpdate dbm-update</span></code></pre></td></tr></table></div></figure>


<p>順利的話 dbToUpdate 定義之舊的 database schema 將會被更新的跟 dev 一樣，接著我們必須將版本記錄更新到最新，因為剛剛執行 dbm-update 的對象是 newChangelog.groovy 同樣會將更新記錄寫入 DATABASECHANGELOG table，該記錄是為了升級用，並不是正式加入控管的記錄，且一開始就開始進行版控的 db 不會有升級的版本記錄，因此我們需要先清除在產生新的 changelog，步驟如下：</p>

<ol>
<li>先把剛剛更新 newChangelog.groovy 的版本記錄 DATABASECHANGELOG 刪掉</li>
<li>將 config.groovy 的 <code>grails.plugin.databasemigration.changelogFileName = newChangelog.groovy</code> 刪除，或是調整回 <code>changelog.groovy</code>，表示回到正式版控內。</li>
<li>寫入從開始版控到最近變更的版本記錄 grails -Dgrails.env=dbToUpdate dbm-changelog-sync</li>
</ol>


<p>透過上述步驟，就可以讓失去控制的舊有 database 回到正軌，之後就可以透過版本控制隨時保持在最新狀態。</p>

<p>當然，一定還有些狀況沒辦法透過比對自動產生，如果你需要對資料庫進行欄位轉換或是特殊處理，下面接著說明。</p>

<h2>客製資料庫更新語法</h2>

<p>假設你有新增欄位，該欄位需要預設值時，可使用下列語法進行：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>databaseChangeLog = {
</span><span class='line'>
</span><span class='line'>    changeSet(author: "wpgreenway", id: "add-date-created-to-post") {
</span><span class='line'>        addColumn(tableName: "post") {
</span><span class='line'>            column(name: "date_created", type: "timestamp")
</span><span class='line'>        }
</span><span class='line'>
</span><span class='line'>        grailsChange {
</span><span class='line'>            change {
</span><span class='line'>                sql.execute("UPDATE post SET date_created = NOW()")
</span><span class='line'>            }
</span><span class='line'>            rollback {
</span><span class='line'>            }
</span><span class='line'>        }
</span><span class='line'>
</span><span class='line'>        addNotNullConstraint(tableName: "post", columnName: "date_created")
</span><span class='line'>    }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>其中可以看到 rollback 的 block，你也可以定義如果需要進行 rollback 時要執行的語法，上述是不懂 gorm 可以用一般的 sql 來進行，如果你熟 gorm，可以使用下列語法，不過在一開始的介紹的連結 <a href="http://wpgreenway.com/posts/grails-db-migration-tutorial/">Grails Db Migration Tutorial</a> 有提到這樣的作法是危險的，這邊不多說明，可參考連結中的敘述，這裡只是記錄也可以這樣進行操作。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>grailsChange {
</span><span class='line'>  change {
</span><span class='line'>    Post.list().each { post -&gt;
</span><span class='line'>      post.dateCreated = new Date()
</span><span class='line'>      post.save(failOnError: true, flush: true)
</span><span class='line'>    }
</span><span class='line'>  }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>或許有讀者會覺得，我用 sql 檔案也同樣能夠做到資料庫版本更新，又何必要透過類似 migration 的機制？跟一般 sql 檔案控管還有不同的地方，上述自定的 sql 更新記錄同樣的也會加入到 DATABASECHANGELOG，沒有任何一個變更會被遺漏，只要有正確的版本記錄，migration 都會一一的進行更新。</p>

<p>最後，一但所有更新語法都準備就緒實際應用在 production，總不希望還需要手動下指令，migration 提供下列設定來自動完成資料庫更新的動作。</p>

<h2>應用程式運行時自動進行資料更新</h2>

<p>在 config.groovy 加入下列參數</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>grails.plugin.databasemigration.updateOnStart = true
</span><span class='line'>grails.plugin.databasemigration.updateOnStartFileNames = ['changelog.groovy']</span></code></pre></td></tr></table></div></figure>


<p>一旦系統運行將會自動比對 cheangelog，你也可以根據不同的 environments 設置不同的比對 chnagelog file，又或者有客製情形可以調整</p>

<p>接著運行 run-app 就會開始比對 changelog 並且更新 database，確認 schema 沒問題時 deploy 到遠端自動執行 schema 調整。</p>

<h2>其他使用注意事項</h2>

<p>有時候，執行 <code>grails dev dbm-update</code> 指令會失敗，可能因為你的專案加了不同的 plugin 改變了產生 doamin 的方式，或是 plugin 中有各自維護的 domain，以筆者的狀況使用了 <a href="http://www.grails.org/plugin/taggable">Taggable Plugin</a> 有自己維護的 table，可以利用 [應用程式運行時自動進行資料更新] 來執行上述指令，筆者在進行舊有資料庫升級時同樣也有上述指令沒有辦法運作的情形，也是透過 [應用程式運行時自動進行資料更新] 完成更新。</p>

<p>另外，如果執行 <code>grails dev dbm-update</code> 時出現下面錯誤</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Message: Validation Failed:
</span><span class='line'>     1 change sets check sum</span></code></pre></td></tr></table></div></figure>


<p>可透過下面語法先清除 MD5SUM</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>grails dev dbm-clear-checksums</span></code></pre></td></tr></table></div></figure>


<p>再一次執行 <code>grails dev dbm-update</code> 即可</p>

<p>如果你有使用 searchable 套件，你會發現若你變更欄位限制式時，在執行 dbm-gorm-diff 可以正常運作，但若你在有支援 seachable 的 domain 新增欄位時在執行 dbm-gorm-diff 會出現下列錯誤訊息</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[Compass Gps Index [pool-8-thread-3]] ERROR util.JDBCExceptionReporter  - Unknown column 'user0_.has_tour' in 'field list'
</span><span class='line'>
</span><span class='line'>[Compass Gps Index [pool-8-thread-3]] ERROR indexer.ScrollableHibernateIndexEntitiesIndexer  - {hibernate}: Failed to index the database
</span><span class='line'>Message: could not load an entity: [app.User#182]</span></code></pre></td></tr></table></div></figure>


<p>只要把 domain 中 static searchable 關鍵字移除舊可以正常運作，在執行 migrations 操作，有未知的異常時，記得先檢查你在 domain 中有沒有特殊的關鍵字，有可以造成誤判或是相互影響</p>

<h2>如果沒有用 grails 開發想使用 migration</h2>

<p>我相信 migration 這樣的機制在每種不同的語言一定有類似的套件提供相同的功能，希望透過這樣的介紹讓讀者知道原來 database 也可以進行版本控制，不需要很複雜也可以做到，有時候就是不知道所以也不知道該怎麼下手。</p>

<p>另外一個方向，如果真的找不到目前專案使用語言有類似 migration 這樣的套件，也可以透過 grails 來中介，將 domain mapping 到既有的 database，在 mapping 時 datasource 定義 <code>dbCreate = "validate"</code>，可以部分 mapping 就開始進行版控，陸續在加入， 一點想法給大家參考。</p>

<p>最後附上本篇文章範例程式位置：</p>

<p><a href="https://github.com/smlsunxie/grailsMigrationsTest">grailsMigrationsTest</a></p>

  </div>


  

  <hr>
  <div class="post-meta">
    
    <span>








  




<i class="mini-ico-calendar"></i><time datetime="2014-01-19T00:00:00+08:00" pubdate data-updated="true">Jan 19<span>th</span>, 2014</time></span>

    <span><i class="mini-ico-bookmark"></i><a rel="bookmark" href="/blog/2014/01/19/Grails-migrations-database/"></a></span>
    

    
    <span><i class="mini-ico-comment"></i><a class="comments-link" href="/blog/2014/01/19/Grails-migrations-database/#disqus_thread">View comments &raquo;</a></span>
    

    

  </div>

  



</div>
    </div>
    



    <ul class="pagination">
      
        <a class="prev" href="/blog/page/2/"><li>&larr; Older</li></a>
      
      <a href="/archives"><li>Blog Archives</li></a>
      
    </ul>


  </div>




  

</div>




   	 	</div>
  	</div>
 	



 	 
	<div id="wrapper">	
		<div class="container">
	    	<div class="sidebar row">
				
			    
<section class="span3">
  <h1>Latest Tweets</h1>
  <ul id="tweets" data-user="smlsun" data-count="4" data-replies="true">
    <li class="loading">Status updating...</li>
  </ul>
  
    <a href="http://twitter.com/smlsun" class="twitter-follow-button" data-show-count="true">Follow @smlsun</a>
  
</section>

<section class="span3">
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li>
        <a href="/blog/2014/01/20/Moto-Ranger/">服務上線發表-Moto Ranger 線上摩托維修記錄</a>
      </li>
    
      <li>
        <a href="/blog/2014/01/19/ubuntu/">ubuntu 忘記密碼怎麼辦？三個步驟完成修改</a>
      </li>
    
      <li>
        <a href="/blog/2014/01/19/rabbit-MQ-Spring-boot/">Rabbit Mq Spring Boot</a>
      </li>
    
      <li>
        <a href="/blog/2014/01/19/rabbit-MQ/">rabbit MQ 使用者建立與權限設定</a>
      </li>
    
      <li>
        <a href="/blog/2014/01/19/Window/">Window 設定：開機自動執行程式或 *.bat 不需登入，以啟動 spring-boot 應用程式為例，加映 command line 就能搞定的 geek 版</a>
      </li>
    
  </ul>
</section>

<section class="span3">
  <h1>On GitHub</h1>
  <ul id="gh_repos" data-user="smlsunxie" data-count="5" data-skip="true">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a class="github-follow" href="https://github.com/smlsunxie">Follow @smlsunxie</a>
  
</section>

<section class="span3">
  <h1>Recent Comments</h1>
  <div id="dsq-recentcomments" class="dsq-widget"><script type="text/javascript" src="http://disqus.com/forums/smlsunxie/recent_comments_widget.js?hide_avatars=1"></script></div>
</section>
<section class="span3">
  <h1>On Delicious</h1>
  <div id="delicious"></div>
  <script type="text/javascript" src="http://feeds.delicious.com/v2/json/smlsun?count=10&amp;sort=date&amp;callback=octopress.renderDeliciousLinks"></script>
  <p><a href="http://delicious.com/smlsun">My Delicious Bookmarks &raquo;</a></p>
</section>

			  <section class="span3">
				  <h1>QR CODE</h1>
				  <img src="https://lh6.googleusercontent.com/-SvgqNNgd2uU/UNlvDlraTzI/AAAAAAAALao/qfmOSCFhsoY/s480/qrcode%2520smlsun.com.jpg" />
				</section><section id="social-r" class="span3">
  <h1>Sharing</h1>
  
    
      <a href="http://twitter.com/share" title="Tweet this" class="twitter-share-button" data-url="http://smlsun.com/blog/index.html" data-via="smlsun" data-counturl="http://smlsun.com/blog/index.html" target="_blank" >Tweet</a>
    
  
  
    
      <div class="g-plusone" data-size="medium"></div>
    
  
  
    
      <div class="fb-like" data-send="true" data-width="450" data-show-faces="false"></div>
    
  
  

</section>

			  



	   	 	</div>
   	 	</div>
  	</div>
  	

<!-- 
<div id="footer">
		

	<div class="container">
		

		<div class="row">								
			
			
		</div>

		
	</div>


</div>
 -->



<div id="footer-menu" class="hidden-tablet hidden-phone">

		<!-- start: Container -->
		<div class="container">
			
			<!-- start: Row -->
			<div class="row">

				<!-- start: Footer Menu Logo -->
				<div class="span2">
					<div id="footer-menu-logo">
						<a class="brand" href="#">smlsun.</a>
					</div>
				</div>
				<!-- end: Footer Menu Logo -->

				<!-- start: Footer Menu Links-->
				<div class="span9">
					
					<div id="footer-menu-links">

						<ul id="footer-nav">
								<li  >
		<a href="/">Home</a>
	</li>
  
  <li class="active" >
  	<a href="/blog">Blog</a>
  </li>

  <li >
  	<a href="/archives">Archives</a>
  </li>
  
  <li >
    <a href="/aboutme">AboutMe</a>
  </li>

  <li >
  	<a href="/slides">Slides</a>
  </li>


						</ul>

					</div>
					
				</div>
				<!-- end: Footer Menu Links-->

				<!-- start: Footer Menu Back To Top -->
				<div class="span1">
						
					<div id="footer-menu-back-to-top">
						<a href="#"></a>
					</div>
				
				</div>
				<!-- end: Footer Menu Back To Top -->
			
			</div>
			<!-- end: Row -->
			
		</div>
		<!-- end: Container  -->	

	</div>



	

<div id="copyright">
	
	<!-- start: Container -->
	<div class="container">
	
		<div class="sixteen columns">
			<p>
			  © 2014 - smlsun 
			  <br>
			  Powered by <a href="http://octopress.org">Octopress</a>
			  <br>theme by <a href="https://github.com/smlsunxie/bootstrapDeck.js">smlsun</a><img src="/assets/magnus/img/poland.png" alt="Poland" style="margin-top:-4px">
			</p>
		</div>

	</div>
	<!-- end: Container  -->
	
</div>







  

<script type="text/javascript">
      var disqus_shortname = 'smlsunxie';
			var disqus_developer = '';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



  
<div id="fb-root"></div>
<script type="text/javascript">
(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0]; 
  if (d.getElementById(id)) return;
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/zh_TW/all.js#xfbml=1&appId=391840470897203";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));

</script>






  
  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>


  
  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>







</body>
</html>
